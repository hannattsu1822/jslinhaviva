<!DOCTYPE html>
<html lang="pt-BR">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Linha Viva | Login Moderno</title>
    <link rel="stylesheet" href="/static/css/index.css" />
    <link
      href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600;700&display=swap"
      rel="stylesheet"
    />
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"
    />
  </head>

  <body>
    <div class="login-container">
      <div class="login-header">
        <div class="logo">
          <i class="fas fa-bolt"></i>
          <h1>Linha Viva</h1>
          <p>Sistema Integrado de Inspeções</p>
        </div>
      </div>

      <form class="login-form" id="loginForm">
        <div class="input-group">
          <input type="text" id="matricula" placeholder="Matrícula" required />
          <i class="fas fa-user"></i>
        </div>

        <div class="input-group">
          <input type="password" id="senha" placeholder="Senha" required />
          <i class="fas fa-lock"></i>
        </div>

        <button type="button" onclick="handleLoginAttempt()" class="login-btn">
          <span>Acessar Sistema</span>
          <i class="fas fa-arrow-right"></i>
        </button>
      </form>

      <div id="login-message"></div>
    </div>

    <div id="welcomeCard" class="welcome-card">
      <div class="welcome-card-header">
        <i class="fas fa-check-circle"></i>
        <span id="welcomeCardTitle">Login Bem-sucedido!</span>
      </div>
      <div class="welcome-card-body">
        <p>Olá, <strong id="welcomeCardUserName"></strong>!</p>
        <p id="welcomeCardLastAccess" class="last-access"></p>
      </div>
      <button id="closeWelcomeCard" class="close-welcome-card-btn">
        &times;
      </button>
    </div>

    <script type="module">
      import { messaging, getToken } from "/firebase-init.js";

      async function solicitarPermissaoEEnviarToken() {
        try {
          console.log("1. Iniciando a função solicitarPermissaoEEnviarToken.");
          
          const permissao = await Notification.requestPermission();
          
          console.log("2. Resultado da permissão:", permissao);

          if (permissao === "granted") {
            const vapidKey = "BJnPkIW3H37oCl0O19lxQWbfUcZt55TD2Qghf2UtWajPuWpCfev09kGf_LF8Uxq1d-QUZAFn_8tJqCbuLnBRPdY";
            
            console.log("3. Permissão concedida. Tentando obter o token...");

            const currentToken = await getToken(messaging, { vapidKey: vapidKey });

            if (currentToken) {
              console.log("4. TOKEN OBTIDO COM SUCESSO:", currentToken);
              
              console.log("5. Enviando token para o backend em /api/me/fcm-token...");

              const response = await fetch("/api/me/fcm-token", {
                method: "PATCH",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({ fcm_token: currentToken }),
              });

              console.log("6. Resposta do backend:", response.status);
              if (!response.ok) {
                console.error("6.1. Erro do backend:", await response.text());
              } else {
                console.log("6.1. Sucesso! Backend respondeu OK.");
              }

            } else {
              console.error("ERRO: Permissão concedida, mas o token não foi gerado. Verifique a VAPID key e a configuração do Firebase.");
            }
          } else {
            console.warn("AVISO: Permissão para notificações foi negada pelo usuário.");
          }
        } catch (error) {
          console.error("ERRO CRÍTICO ao obter o token FCM:", error);
        }
      }

      console.log("Script de login iniciado.");
      const loginForm = document.getElementById("loginForm");
      const matriculaInput = document.getElementById("matricula");
      const senhaInput = document.getElementById("senha");
      const messageEl = document.getElementById("login-message");
      const loginButton = loginForm.querySelector(".login-btn");
      const loginButtonSpan = loginButton
        ? loginButton.querySelector("span")
        : null;
      const originalButtonTextContent = loginButtonSpan
        ? loginButtonSpan.textContent
        : "Acessar Sistema";

      const welcomeCardEl = document.getElementById("welcomeCard");
      const welcomeCardUserNameEl = document.getElementById(
        "welcomeCardUserName"
      );
      const welcomeCardLastAccessEl = document.getElementById(
        "welcomeCardLastAccess"
      );
      const closeWelcomeCardBtn = document.getElementById("closeWelcomeCard");

      if (!matriculaInput) {
        console.error("[Debug] ERRO: matriculaInput não encontrado no DOM!");
      }
      if (!senhaInput) {
        console.error("[Debug] ERRO: senhaInput não encontrado no DOM!");
      }
      if (!loginButton) {
        console.error("[Debug] ERRO: loginButton não encontrado no DOM!");
      }

      function resetLoginForm() {
        if (matriculaInput) {
          matriculaInput.value = "";
        }
        if (senhaInput) {
          senhaInput.value = "";
        }
        hideMessage();

        if (loginButton && loginButtonSpan) {
          loginButton.disabled = false;
          loginButtonSpan.textContent = originalButtonTextContent;
        }
      }

      function showWelcomeCard(userData) {
        if (
          !welcomeCardEl ||
          !welcomeCardUserNameEl ||
          !welcomeCardLastAccessEl
        ) {
          return;
        }

        welcomeCardUserNameEl.textContent = userData.nome || "Usuário";

        let lastAccessDisplay = "Este é seu primeiro acesso!";
        const lastLoginTimestamp = localStorage.getItem("lastLoginTimestamp");

        if (userData.ultimoAcesso) {
          const date = new Date(userData.ultimoAcesso);
          lastAccessDisplay = `Último acesso: ${date.toLocaleDateString(
            "pt-BR"
          )} às ${date.toLocaleTimeString("pt-BR")}`;
        } else if (lastLoginTimestamp) {
          const date = new Date(parseInt(lastLoginTimestamp, 10));
          lastAccessDisplay = `Último acesso: ${date.toLocaleDateString(
            "pt-BR"
          )} às ${date.toLocaleTimeString("pt-BR")}`;
        }
        welcomeCardLastAccessEl.textContent = lastAccessDisplay;

        localStorage.setItem("lastLoginTimestamp", Date.now().toString());
        welcomeCardEl.classList.add("show");

        setTimeout(() => {
          hideWelcomeCard();
        }, 5000);
      }

      function hideWelcomeCard() {
        if (welcomeCardEl) {
          welcomeCardEl.classList.remove("show");
        }
      }

      if (closeWelcomeCardBtn) {
        closeWelcomeCardBtn.addEventListener("click", hideWelcomeCard);
      }

      async function performLogin() {
        const matricula = matriculaInput.value.trim();
        const senha = senhaInput.value.trim();

        if (!matricula || !senha) {
          showMessage("Matrícula e senha são obrigatórios.", "error");
          return;
        }
        hideMessage();

        loginButton.disabled = true;
        loginButtonSpan.textContent = "Acessando...";

        let responseOk = false;

        try {
          const actualResponse = await fetch("/login", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ matricula, senha }),
          });
          const actualResult = await actualResponse.json();

          const currentResponse = actualResponse;
          const currentResult = actualResult;

          if (!currentResponse) {
            throw new Error("Resposta da API não definida.");
          }

          if (currentResponse.ok) {
            responseOk = true;

            const userDataForCard = {
              nome: currentResult.user ? currentResult.user.nome : "Usuário",
              ultimoAcesso: currentResult.user
                ? currentResult.user.ultimoAcesso
                : null,
            };
            showWelcomeCard(userDataForCard);

            localStorage.setItem("user", JSON.stringify(currentResult.user));
            
            await solicitarPermissaoEEnviarToken();

            document.removeEventListener("keydown", handleEnterKey);

            setTimeout(() => {
              window.location.href = "/dashboard";
            }, 2750);
          } else {
            showMessage(
              currentResult.message ||
                "Credenciais inválidas. Verifique seus dados.",
              "error"
            );
            if (senhaInput) {
              senhaInput.value = "";
              senhaInput.focus();
            }
          }
        } catch (error) {
          showMessage(
            "Erro de conexão ou falha inesperada. Tente novamente.",
            "error"
          );
          if (senhaInput) {
            senhaInput.value = "";
            senhaInput.focus();
          }
        } finally {
          if (!responseOk) {
            loginButton.disabled = false;
            loginButtonSpan.textContent = originalButtonTextContent;
          } else {
            if (loginButtonSpan.textContent === "Acessando...") {
              loginButtonSpan.textContent = "Redirecionando...";
            }
          }
        }
      }

      function showMessage(message, type = "error") {
        messageEl.textContent = message;
        messageEl.className = "login-message-active";

        if (type === "error") {
          messageEl.style.backgroundColor = "#f8d7da";
          messageEl.style.color = "#721c24";
          messageEl.style.borderColor = "#f5c6cb";
        } else if (type === "success") {
          messageEl.style.backgroundColor = "#d4edda";
          messageEl.style.color = "#155724";
          messageEl.style.borderColor = "#c3e6cb";
        } else {
          messageEl.style.backgroundColor = "#e2e3e5";
          messageEl.style.color = "#495057";
          messageEl.style.borderColor = "#d6d8db";
        }
      }

      function hideMessage() {
        messageEl.className = "";
        messageEl.textContent = "";
      }

      window.handleLoginAttempt = function() {
        if (loginButton.disabled) {
          return;
        }
        performLogin();
      }

      if (loginForm) {
        loginForm.addEventListener("submit", function (event) {
          event.preventDefault();
          handleLoginAttempt();
        });
      }

      function handleEnterKey(event) {
        const keyPressed = event.key;
        const keyCodePressed = event.keyCode;
        if (keyPressed === "Enter" || keyCodePressed === 13) {
          event.preventDefault();
          handleLoginAttempt();
        }
      }

      document.addEventListener("keydown", handleEnterKey);

      window.addEventListener("pageshow", function (event) {
        resetLoginForm();
        document.removeEventListener("keydown", handleEnterKey);
        document.addEventListener("keydown", handleEnterKey);
      });

      resetLoginForm();
    </script>
  </body>
</html>

