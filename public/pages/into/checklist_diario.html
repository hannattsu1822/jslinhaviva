<!DOCTYPE html>
<html lang="pt-BR">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Checklist Diário - Linha Viva</title>

    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css"
    />
    <link
      href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap"
      rel="stylesheet"
    />

    <style>
      body {
        font-family: "Poppins", sans-serif;
        background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
        min-height: 100vh;
        padding-bottom: 40px;
        margin: 0;
        overflow-x: hidden;
      }

      .glass-card {
        background: rgba(255, 255, 255, 0.9);
        backdrop-filter: blur(10px);
        -webkit-backdrop-filter: blur(10px);
        border: 1px solid rgba(255, 255, 255, 0.3);
        box-shadow: 0 8px 32px 0 rgba(31, 38, 135, 0.15);
        border-radius: 15px;
        position: relative;
        z-index: 1;
      }

      form,
      input,
      select,
      textarea,
      button {
        position: relative;
        z-index: 10;
      }

      .top-bar {
        padding: 20px 0;
        margin-bottom: 20px;
      }

      .form-control,
      .form-select {
        padding: 0.75rem 1rem;
        font-size: 1rem;
      }

      .upload-area {
        border: 2px dashed #cbd5e0;
        border-radius: 15px;
        padding: 20px;
        text-align: center;
        background: #f8f9fa;
        transition: all 0.3s ease;
        margin-top: 10px;
      }

      .upload-area:hover {
        border-color: #0d6efd;
        background: #fff;
      }

      .upload-btn-wrapper {
        display: flex;
        gap: 15px;
        justify-content: center;
        margin-bottom: 15px;
      }

      .btn-upload-custom {
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        width: 100px;
        height: 100px;
        border-radius: 12px;
        border: none;
        cursor: pointer;
        transition: transform 0.2s, box-shadow 0.2s;
        color: white;
        font-weight: 500;
        font-size: 0.9rem;
        z-index: 20;
      }

      .btn-upload-custom:active {
        transform: scale(0.95);
      }

      .btn-upload-custom:hover {
        box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
      }

      .btn-gallery {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      }

      .btn-camera {
        background: linear-gradient(135deg, #ff9a9e 0%, #fecfef 99%, #fecfef 100%);
        color: #555;
      }

      .btn-upload-custom i {
        font-size: 2rem;
        margin-bottom: 8px;
      }

      .preview-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(100px, 1fr));
        gap: 10px;
        margin-top: 20px;
      }

      .preview-item {
        position: relative;
        width: 100%;
        padding-top: 100%;
        border-radius: 8px;
        overflow: hidden;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        background: #fff;
      }

      .preview-item img {
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        object-fit: cover;
      }

      .btn-remove-img {
        position: absolute;
        top: 5px;
        right: 5px;
        background: rgba(220, 53, 69, 0.9);
        color: white;
        border: none;
        border-radius: 50%;
        width: 24px;
        height: 24px;
        display: flex;
        align-items: center;
        justify-content: center;
        cursor: pointer;
        font-size: 12px;
        transition: background 0.2s;
        z-index: 30;
      }

      .btn-remove-img:hover {
        background: #c82333;
      }

      .status-checklist {
        display: none;
        margin-top: 10px;
        padding: 10px 12px;
        border-radius: 10px;
        font-size: 0.95rem;
        border: 1px solid transparent;
      }

      .status-checklist.info {
        display: block;
        background: #e7f1ff;
        border-color: #b6d4fe;
        color: #084298;
      }

      .status-checklist.success {
        display: block;
        background: #d1e7dd;
        border-color: #badbcc;
        color: #0f5132;
      }

      .status-checklist.error {
        display: block;
        background: #f8d7da;
        border-color: #f5c2c7;
        color: #842029;
      }
    </style>
  </head>

  <body>
    <div class="container">
      <div class="top-bar d-flex align-items-center">
        <a href="/dashboard" class="btn btn-outline-primary fw-bold shadow-sm bg-white">
          <i class="fas fa-arrow-left me-2"></i>Voltar ao Dashboard
        </a>
      </div>

      <div class="row justify-content-center">
        <div class="col-lg-8 col-md-10">
          <div class="text-center mb-4">
            <h2 class="fw-bold text-dark">
              <i class="fas fa-clipboard-check me-2 text-primary"></i>Checklist Diário
            </h2>
            <p class="text-muted">
              Preencha os dados abaixo para liberar o uso do veículo.
            </p>
          </div>

          <div class="card glass-card">
            <div class="card-body p-4">
              <form id="checklistForm">
                <h5 class="mb-3 text-primary border-bottom pb-2">Identificação</h5>

                <div class="row g-3 mb-2">
                  <div class="col-md-6">
                    <label class="form-label fw-bold">Placa do Veículo</label>
                    <input
                      type="text"
                      class="form-control"
                      name="placa"
                      id="placa"
                      required
                      placeholder="ABC-1234"
                      style="text-transform: uppercase"
                      autocomplete="off"
                    />
                    <div id="statusChecklist" class="status-checklist info"></div>
                  </div>

                  <div class="col-md-6">
                    <label class="form-label fw-bold">Quilometragem (KM)</label>
                    <input
                      type="number"
                      class="form-control"
                      name="km"
                      id="km"
                      required
                      placeholder="Ex: 150000"
                      min="0"
                      step="1"
                    />
                  </div>
                </div>

                <div class="row g-3 mb-4">
                  <div class="col-12">
                    <small class="text-muted">
                      Observação: só é permitido 1 checklist por dia para a mesma placa.
                    </small>
                  </div>
                </div>

                <h5 class="mb-3 text-primary border-bottom pb-2">Itens de Verificação</h5>

                <div class="row g-3 mb-4">
                  <div class="col-md-4">
                    <label class="form-label">Nível de óleo</label>
                    <select class="form-select" name="oleo" required>
                      <option value="OK">OK Normal</option>
                      <option value="BAIXO">Baixo</option>
                      <option value="CRITICO">Crítico</option>
                    </select>
                  </div>

                  <div class="col-md-4">
                    <label class="form-label">Nível de água</label>
                    <select class="form-select" name="agua" required>
                      <option value="OK">OK Normal</option>
                      <option value="BAIXO">Baixo</option>
                    </select>
                  </div>

                  <div class="col-md-4">
                    <label class="form-label">Pneus</label>
                    <select class="form-select" name="pneus" required>
                      <option value="OK">Calibrados</option>
                      <option value="NAOOK">Baixos / Murchos</option>
                    </select>
                  </div>

                  <div class="col-md-6">
                    <label class="form-label">Luzes / Setas</label>
                    <select class="form-select" name="luzes" required>
                      <option value="OK">Funcionando</option>
                      <option value="DEFEITO">Queimadas / Defeito</option>
                    </select>
                  </div>

                  <div class="col-md-6">
                    <label class="form-label">Freios</label>
                    <select class="form-select" name="freios" required>
                      <option value="OK">Funcionando</option>
                      <option value="RUIM">Ruim / Barulho</option>
                    </select>
                  </div>

                  <div class="col-12 mt-3">
                    <div class="form-check form-switch p-3 bg-light rounded border">
                      <input
                        class="form-check-input ms-0 me-2"
                        type="checkbox"
                        id="latariaCheck"
                        name="lataria"
                        style="cursor: pointer"
                      />
                      <label
                        class="form-check-label fw-bold"
                        for="latariaCheck"
                        style="cursor: pointer"
                      >
                        Há novas avarias na lataria?
                      </label>
                    </div>
                  </div>
                </div>

                <h5 class="mb-3 text-primary border-bottom pb-2">Observações</h5>

                <div class="mb-4">
                  <textarea
                    class="form-control"
                    name="observacoes"
                    rows="3"
                    placeholder="Descreva qualquer problema encontrado..."
                  ></textarea>
                </div>

                <h5 class="mb-3 text-primary border-bottom pb-2">Fotos Obrigatórias</h5>
                <p class="text-muted small">
                  Tire fotos do painel (KM), combustível e de eventuais avarias.
                </p>

                <div class="upload-area">
                  <input type="file" id="fileInput" multiple accept="image/*" hidden />
                  <input
                    type="file"
                    id="cameraInput"
                    capture="environment"
                    accept="image/*"
                    hidden
                  />

                  <div class="upload-btn-wrapper">
                    <button
                      type="button"
                      class="btn-upload-custom btn-gallery"
                      onclick="document.getElementById('fileInput').click()"
                    >
                      <i class="fas fa-images"></i>
                      Galeria
                    </button>

                    <button
                      type="button"
                      class="btn-upload-custom btn-camera"
                      onclick="document.getElementById('cameraInput').click()"
                    >
                      <i class="fas fa-camera"></i>
                      Câmera
                    </button>
                  </div>

                  <small class="text-muted">Clique nos botões acima para adicionar</small>
                  <div id="previewContainer" class="preview-grid"></div>
                </div>

                <div class="d-grid gap-2 mt-5">
                  <button
                    type="submit"
                    id="btnSubmit"
                    class="btn btn-success btn-lg fw-bold py-3 shadow"
                  >
                    <i class="fas fa-check-circle me-2"></i>ENVIAR CHECKLIST
                  </button>
                </div>
              </form>
            </div>
          </div>

          <div class="text-center mt-3 text-muted small">
            Linha Viva System
          </div>
        </div>
      </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

    <script>
      let selectedFiles = [];

      const fileInput = document.getElementById("fileInput");
      const cameraInput = document.getElementById("cameraInput");
      const previewContainer = document.getElementById("previewContainer");

      const placaInput = document.getElementById("placa");
      const statusChecklistEl = document.getElementById("statusChecklist");
      const btnSubmit = document.getElementById("btnSubmit");

      let placaStatusCache = { placa: "", realizado: false, checkedAt: 0 };

      function getAuthHeadersIfAny() {
        const token = localStorage.getItem("token");
        if (!token) return {};
        return { Authorization: `Bearer ${token}` };
      }

      function normalizePlaca(value) {
        return String(value || "")
          .trim()
          .toUpperCase()
          .replace(/\s+/g, "")
          .replace(/[^A-Z0-9-]/g, "");
      }

      function setStatusMessage(type, text) {
        if (!statusChecklistEl) return;

        if (!text) {
          statusChecklistEl.className = "status-checklist";
          statusChecklistEl.textContent = "";
          return;
        }

        statusChecklistEl.className = `status-checklist ${type}`;
        statusChecklistEl.textContent = text;
      }

      function setSubmitEnabled(enabled) {
        if (!btnSubmit) return;
        btnSubmit.disabled = !enabled;
      }

      function debounce(fn, wait) {
        let t = null;
        return function (...args) {
          clearTimeout(t);
          t = setTimeout(() => fn.apply(this, args), wait);
        };
      }

      async function verificarChecklistDoDiaPorPlaca(placaRaw) {
        const placa = normalizePlaca(placaRaw);

        if (!placa) {
          placaStatusCache = { placa: "", realizado: false, checkedAt: 0 };
          setStatusMessage("info", "");
          setSubmitEnabled(true);
          return { realizado: false };
        }

        const now = Date.now();
        if (placaStatusCache.placa === placa && now - placaStatusCache.checkedAt < 15000) {
          if (placaStatusCache.realizado) {
            setStatusMessage(
              "error",
              "Checklist do dia já foi realizado para esta placa. Envio bloqueado."
            );
            setSubmitEnabled(false);
          } else {
            setStatusMessage("success", "Nenhum checklist do dia encontrado para esta placa.");
            setSubmitEnabled(true);
          }
          return { realizado: placaStatusCache.realizado };
        }

        setStatusMessage("info", "Verificando checklist do dia para esta placa...");
        setSubmitEnabled(false);

        try {
          const response = await fetch(
            `/api/checklist_status?placa=${encodeURIComponent(placa)}`,
            { headers: { ...getAuthHeadersIfAny() } }
          );

          const data = await response.json().catch(() => null);

          if (!response.ok) {
            const msg = (data && data.message) ? data.message : `Erro HTTP: ${response.status}`;
            throw new Error(msg);
          }

          const realizado = !!(data && data.realizado);

          placaStatusCache = { placa, realizado, checkedAt: Date.now() };

          if (realizado) {
            setStatusMessage(
              "error",
              "Checklist do dia já foi realizado para esta placa. Envio bloqueado."
            );
            setSubmitEnabled(false);
          } else {
            setStatusMessage("success", "Nenhum checklist do dia encontrado para esta placa.");
            setSubmitEnabled(true);
          }

          return { realizado };
        } catch (err) {
          placaStatusCache = { placa, realizado: false, checkedAt: Date.now() };
          setStatusMessage(
            "info",
            "Não foi possível validar agora. Você ainda pode tentar enviar; o servidor validará."
          );
          setSubmitEnabled(true);
          return { realizado: false, error: err.message };
        }
      }

      const verificarDebounced = debounce(() => {
        verificarChecklistDoDiaPorPlaca(placaInput ? placaInput.value : "");
      }, 400);

      function handleFileSelect(event) {
        const files = Array.from(event.target.files || []);
        files.forEach((file) => {
          if (file && file.type && file.type.startsWith("image/")) {
            selectedFiles.push(file);
          }
        });
        renderPreview();
        event.target.value = "";
      }

      function renderPreview() {
        if (!previewContainer) return;
        previewContainer.innerHTML = "";

        selectedFiles.forEach((file, index) => {
          const reader = new FileReader();
          reader.onload = function (e) {
            const div = document.createElement("div");
            div.className = "preview-item";
            div.innerHTML = `
              <img src="${e.target.result}" alt="Preview" />
              <button type="button" class="btn-remove-img" data-index="${index}">
                <i class="fas fa-times"></i>
              </button>
            `;
            previewContainer.appendChild(div);
          };
          reader.readAsDataURL(file);
        });
      }

      function removeFile(index) {
        selectedFiles.splice(index, 1);
        renderPreview();
      }

      if (fileInput) fileInput.addEventListener("change", handleFileSelect);
      if (cameraInput) cameraInput.addEventListener("change", handleFileSelect);

      if (previewContainer) {
        previewContainer.addEventListener("click", (e) => {
          const btn = e.target.closest(".btn-remove-img");
          if (!btn) return;
          const idx = Number(btn.getAttribute("data-index"));
          if (!Number.isNaN(idx)) removeFile(idx);
        });
      }

      if (placaInput) {
        placaInput.addEventListener("input", verificarDebounced);
        placaInput.addEventListener("blur", () =>
          verificarChecklistDoDiaPorPlaca(placaInput.value)
        );
      }

      document
        .getElementById("checklistForm")
        .addEventListener("submit", async function (e) {
          e.preventDefault();

          const placaValue = placaInput ? placaInput.value : "";
          const check = await verificarChecklistDoDiaPorPlaca(placaValue);

          if (check && check.realizado) {
            alert("Checklist já realizado hoje para esta placa. Envio bloqueado.");
            return;
          }

          if (selectedFiles.length === 0) {
            alert("Por favor, adicione pelo menos uma foto (ex: Painel do veículo).");
            return;
          }

          const btn = this.querySelector('button[type="submit"]');
          const originalText = btn.innerHTML;
          btn.disabled = true;
          btn.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>Enviando...';

          const formData = new FormData(this);

          selectedFiles.forEach((file) => {
            formData.append("fotosveiculo", file);
          });

          if (!formData.has("lataria")) {
            formData.append("lataria", "0");
          } else {
            formData.set("lataria", "1");
          }

          try {
            const response = await fetch("/api/checklist/salvar", {
              method: "POST",
              headers: { ...getAuthHeadersIfAny() },
              body: formData,
            });

            const result = await response.json().catch(() => ({}));

            if (response.ok) {
              alert("Checklist enviado com sucesso!");
              window.location.href = "/dashboard";
              return;
            }

            const msg = result && result.message ? result.message : "Erro desconhecido";
            alert("Erro ao salvar: " + msg);
          } catch (error) {
            console.error(error);
            alert("Erro de conexão ao salvar checklist.");
          } finally {
            btn.disabled = false;
            btn.innerHTML = originalText;
          }
        });
    </script>
  </body>
</html>
