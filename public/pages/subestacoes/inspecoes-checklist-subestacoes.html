<!DOCTYPE html>
<html lang="pt-BR">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Checklist de Inspeção de Subestação</title>
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css"
      rel="stylesheet"
      integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH"
      crossorigin="anonymous"
    />
    <link
      rel="stylesheet"
      href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@24,400,0,0"
    />
    <link
      rel="stylesheet"
      href="/static/css/subestacoes/inspecoes-checklist-subestacoes.css"
    />
  </head>
  <body>
    <div class="container mt-4 mb-5">
      <header class="page-header mb-4 p-3 rounded">
        <h1 class="h3 mb-0 d-flex align-items-center">
          <span class="material-symbols-outlined fs-1 me-2">checklist_rtl</span>
          Checklist de Inspeção de Subestação
        </h1>
      </header>

      <main>
        <form id="formChecklistInspecao" enctype="multipart/form-data">
          <section id="cabecalhoInspecao" class="custom-card mb-4">
            <div class="custom-card-header">
              <h2 class="h5 mb-0 d-flex align-items-center">
                <span class="material-symbols-outlined me-2"
                  >assignment_ind</span
                >
                Dados da Inspeção
              </h2>
            </div>
            <div class="custom-card-body">
              <div class="row g-3">
                <div class="col-md-6 col-lg-4">
                  <label for="inspecaoSubestacao" class="form-label"
                    >Subestação:*</label
                  >
                  <select
                    id="inspecaoSubestacao"
                    name="subestacao_id"
                    class="form-select form-select-sm"
                    required
                  >
                    <option value="">Carregando...</option>
                  </select>
                </div>
                <div class="col-md-6 col-lg-4">
                  <label for="inspecaoResponsavel" class="form-label"
                    >Responsável:*</label
                  >
                  <select
                    id="inspecaoResponsavel"
                    name="responsavel_levantamento_id"
                    class="form-select form-select-sm"
                    required
                  >
                    <option value="">Carregando...</option>
                  </select>
                </div>
                <div class="col-md-6 col-lg-4">
                  <label for="inspecaoFormularioNumDisplay" class="form-label"
                    >Nº da Inspeção:</label
                  >
                  <input
                    type="text"
                    id="inspecaoFormularioNumDisplay"
                    name="formulario_inspecao_num_display"
                    class="form-control form-control-sm"
                    readonly
                    value="Será gerado ao salvar"
                  />
                </div>
                <div class="col-md-4">
                  <label for="inspecaoDataAvaliacao" class="form-label"
                    >Data Avaliação:*</label
                  >
                  <input
                    type="date"
                    id="inspecaoDataAvaliacao"
                    name="data_avaliacao"
                    class="form-control form-control-sm"
                    required
                  />
                </div>
                <div class="col-md-4">
                  <label for="inspecaoHoraInicial" class="form-label"
                    >Hora Inicial:*</label
                  >
                  <input
                    type="time"
                    id="inspecaoHoraInicial"
                    name="hora_inicial"
                    class="form-control form-control-sm"
                    required
                  />
                </div>
                <div class="col-md-4">
                  <label for="inspecaoHoraFinal" class="form-label"
                    >Hora Final (Opcional):</label
                  >
                  <input
                    type="time"
                    id="inspecaoHoraFinal"
                    name="hora_final"
                    class="form-control form-control-sm"
                  />
                </div>
              </div>
            </div>
          </section>

          <div id="checklistItensContainer" class="mb-4"></div>

          <section id="medicoesEquipamentosSection" class="custom-card mb-4">
            <div
              class="custom-card-header d-flex justify-content-between align-items-center"
            >
              <h2 class="h5 mb-0 d-flex align-items-center">
                <span class="material-symbols-outlined me-2">rule</span>
                Medições de Equipamentos
              </h2>
              <button
                type="button"
                id="btnAdicionarMedicao"
                class="btn btn-sm btn-primary"
              >
                Adicionar Medição
              </button>
            </div>
            <div class="custom-card-body">
              <div id="containerMedicoesDinamicas">
                <p id="nenhumaMedicaoAdicionada" class="text-muted text-center">
                  Nenhuma medição adicionada ainda.
                </p>
              </div>
            </div>
          </section>

          <section id="equipamentosObservadosSection" class="custom-card mb-4">
            <div
              class="custom-card-header d-flex justify-content-between align-items-center"
            >
              <h2 class="h5 mb-0 d-flex align-items-center">
                <span class="material-symbols-outlined me-2">visibility</span>
                Equipamentos Observados/Inspecionados
              </h2>
              <button
                type="button"
                id="btnAdicionarEquipamentoObservado"
                class="btn btn-sm btn-primary"
              >
                Adicionar Equipamento
              </button>
            </div>
            <div class="custom-card-body">
              <div id="containerEquipamentosObservados">
                <p
                  id="nenhumEquipamentoObservado"
                  class="text-muted text-center"
                >
                  Nenhum equipamento observado adicionado ainda.
                </p>
              </div>
            </div>
          </section>

          <section id="verificacoesAdicionaisSection" class="custom-card mb-4">
            <div
              class="custom-card-header d-flex justify-content-between align-items-center"
            >
              <h2 class="h5 mb-0 d-flex align-items-center">
                <span class="material-symbols-outlined me-2"
                  >playlist_add_check_circle</span
                >
                Pontos de Verificação Adicionais
              </h2>
              <button
                type="button"
                id="btnAdicionarVerificacao"
                class="btn btn-sm btn-primary"
              >
                Adicionar Ponto
              </button>
            </div>
            <div class="custom-card-body">
              <div id="containerVerificacoesAdicionais">
                <p
                  id="nenhumaVerificacaoAdicionada"
                  class="text-muted text-center"
                >
                  Nenhum ponto de verificação adicionado ainda.
                </p>
              </div>
            </div>
          </section>

          <section id="anexosInspecaoSection" class="custom-card mb-4">
            <div class="custom-card-header">
              <h2 class="h5 mb-0 d-flex align-items-center">
                <span class="material-symbols-outlined me-2">attachment</span>
                Anexos Gerais da Inspeção
              </h2>
            </div>
            <div class="custom-card-body">
              <fieldset class="anexos-fieldset border p-3 rounded">
                <legend class="legend-sm float-none w-auto px-2">
                  <span class="material-symbols-outlined">file_upload</span>
                  Adicionar Anexos Gerais
                </legend>
                <div class="mb-3">
                  <label
                    for="inspecaoAnexosInput"
                    class="form-label visually-hidden"
                    >Selecionar arquivos (Opcional, máx. 10):</label
                  >
                  <div class="file-input-modern-wrapper">
                    <input
                      type="file"
                      id="inspecaoAnexosInput"
                      name="anexosInspecao"
                      multiple
                      accept=".pdf,.jpg,.jpeg,.png,.doc,.docx,.xls,.xlsx,.txt,.heic,.heif"
                      class="file-input-modern-hidden"
                    />
                    <label
                      for="inspecaoAnexosInput"
                      class="file-input-modern-trigger p-4"
                    >
                      <span
                        class="material-symbols-outlined file-input-icon fs-2 mb-2"
                        >cloud_upload</span
                      >
                      <span class="file-input-text">
                        Arraste arquivos aqui ou
                        <strong>clique para selecionar</strong>.
                        <br />
                        <small class="text-muted d-block mt-1"
                          >(Opcional, máx. 10 arquivos)</small
                        >
                      </span>
                    </label>
                  </div>
                  <ul
                    id="listaNomesAnexosInspecao"
                    class="list-group list-group-flush anexos-list mt-2"
                  ></ul>
                  <small class="form-text text-muted d-block text-center mt-2"
                    >Tipos: PDF, Imagens, Documentos, Planilhas, TXT.</small
                  >
                </div>
              </fieldset>
            </div>
          </section>

          <section id="observacoesGeraisSection" class="custom-card mb-4">
            <div class="custom-card-header">
              <h2 class="h5 mb-0 d-flex align-items-center">
                <span class="material-symbols-outlined me-2"
                  >speaker_notes</span
                >
                Observações Gerais (Campo Livre)
              </h2>
            </div>
            <div class="custom-card-body">
              <div class="mb-2">
                <textarea
                  id="inspecaoObservacoesGerais"
                  name="observacoes_gerais"
                  rows="4"
                  class="form-control form-control-sm"
                  placeholder="Observações gerais sobre a inspeção que não se encaixam nos itens acima..."
                ></textarea>
              </div>
              <p class="legenda-obs alert alert-secondary p-2" role="alert">
                <strong>OBS.:</strong> Toda atividade em subestações exige o uso
                de EPIs.
              </p>
            </div>
          </section>

          <div
            class="d-flex justify-content-end gap-2 p-3 border-top mt-4 bg-light rounded-bottom page-form-actions"
          >
            <button
              type="button"
              id="btnCancelarChecklist"
              class="btn btn-app-clear btn-sm"
            >
              Cancelar
            </button>
            <button
              type="submit"
              id="btnSalvarInspecao"
              class="btn btn-success btn-sm"
            >
              <span class="material-symbols-outlined">save</span> Salvar
              Inspeção
            </button>
          </div>
        </form>
      </main>
    </div>

    <div
      class="modal fade"
      id="modalDetalhesItem"
      tabindex="-1"
      aria-labelledby="modalDetalhesItemLabel"
      aria-hidden="true"
    >
      <div class="modal-dialog modal-lg modal-dialog-centered">
        <div class="modal-content custom-modal-content">
          <div class="modal-header custom-modal-header">
            <h5
              class="modal-title d-flex align-items-center"
              id="modalDetalhesItemLabel"
            >
              <span class="material-symbols-outlined me-2">comment_add</span>
              Detalhes e Evidências do Item
            </h5>
            <button
              type="button"
              class="btn-close"
              data-bs-dismiss="modal"
              aria-label="Fechar"
            ></button>
          </div>
          <div class="modal-body">
            <div
              id="itemDetalhesModalDescricao"
              class="alert alert-secondary p-2 small mb-3"
              role="alert"
            ></div>
            <div class="mb-3">
              <label for="itemObservacaoTextarea" class="form-label"
                >Observação do Item (Obrigatória se Anormal):</label
              >
              <textarea
                id="itemObservacaoTextarea"
                class="form-control form-control-sm"
                rows="3"
                placeholder="Descreva a observação ou justificativa aqui..."
              ></textarea>
            </div>
            <div class="mb-3">
              <label for="fotosItemInput" class="form-label"
                >Fotos de Evidência (Máx. 10, Obrigatória se Anormal):</label
              >
              <div class="file-input-modern-wrapper modal-file-input">
                <input
                  type="file"
                  id="fotosItemInput"
                  name="fotosItem"
                  accept="image/*"
                  multiple
                  class="file-input-modern-hidden"
                />
                <label
                  for="fotosItemInput"
                  class="file-input-modern-trigger p-3"
                >
                  <span
                    class="material-symbols-outlined file-input-icon fs-3 mb-1"
                    >add_a_photo</span
                  >
                  <span class="file-input-text small">
                    Arraste fotos ou <strong>clique para selecionar</strong>.
                    <br />
                    <small
                      id="fotosItemLabelHelper"
                      class="text-muted d-block mt-1"
                      >(Opcional, máx. 10 fotos)</small
                    >
                  </span>
                </label>
              </div>
              <div
                id="fotosItemPreviewContainer"
                class="modal-file-preview-container mt-2 d-flex flex-wrap gap-2"
              ></div>
              <small
                id="fotosItemCount"
                class="form-text text-muted d-block text-center mt-1"
                >0 de 10 fotos selecionadas.</small
              >
            </div>
          </div>
          <div class="modal-footer custom-modal-footer">
            <button
              type="button"
              class="btn btn-app-clear btn-sm"
              data-bs-dismiss="modal"
            >
              Cancelar
            </button>
            <button
              type="button"
              id="btnSalvarDetalhesItem"
              class="btn btn-primary btn-sm"
            >
              <span class="material-symbols-outlined">check_circle</span>
              Confirmar Detalhes do Item
            </button>
          </div>
        </div>
      </div>
    </div>

    <template id="templateLinhaMedicao">
      <div
        class="medicao-dinamica-item row g-3 mb-3 p-3 border rounded align-items-start"
      >
        <div class="col-md-3">
          <label class="form-label form-label-sm">Tipo de Medição:*</label>
          <select
            name="tipo_medicao[]"
            class="form-select form-select-sm tipo-medicao"
            required
          >
            <option value="">Selecione...</option>
            <option value="TEMPERATURA_TRAFO">Temperatura Trafo</option>
            <option value="TEMPERATURA_OLEO">Temperatura Óleo</option>
            <option value="TEMPERATURA_ENROLAMENTO">
              Temperatura Enrolamento
            </option>
            <option value="NIVEL_OLEO">Nível Óleo</option>
            <option value="CONTADOR_RELIGADOR">Contador Religador</option>
            <option value="BATERIA_MONITOR">Bateria Monitor</option>
            <option value="OUTRO">Outro</option>
          </select>
        </div>
        <div class="col-md-2">
          <label class="form-label form-label-sm">TAG Equip.:</label>
          <input
            type="text"
            name="tag_equipamento_medicao[]"
            class="form-control form-control-sm tag-equipamento_medicao"
            placeholder="Ex: F041"
          />
        </div>
        <div class="col-md-2">
          <label class="form-label form-label-sm">Valor Lido:*</label>
          <input
            type="text"
            name="valor_medido[]"
            class="form-control form-control-sm valor-medido"
            required
            placeholder="Ex: 65.5 ou 120"
          />
        </div>
        <div class="col-md-1">
          <label class="form-label form-label-sm">Unid.:</label>
          <input
            type="text"
            name="unidade_medida[]"
            class="form-control form-control-sm unidade-medida"
            placeholder="°C"
          />
        </div>
        <div class="col-md-3">
          <label class="form-label form-label-sm foto-medicao-label"
            >Fotos (Opcional, máx. 5):</label
          >
          <input
            type="file"
            name="foto_medicao[]"
            class="form-control form-control-sm foto-medicao-input"
            accept="image/*"
            multiple
          />
          <div
            class="fotos-medicao-preview-container mt-1 d-flex flex-wrap gap-1"
          ></div>
          <small
            class="form-text text-muted d-block text-center mt-1 fotos-medicao-count"
            >0 de 5 fotos selecionadas.</small
          >
        </div>
        <div
          class="col-md-1 d-flex align-items-center justify-content-end pt-md-4"
        >
          <button
            type="button"
            class="btn btn-danger btn-sm btn-remover-medicao"
            title="Remover Medição"
          >
            <span class="material-symbols-outlined">delete</span>
          </button>
        </div>
        <div class="col-12">
          <label class="form-label form-label-sm">Observação (Opcional):</label>
          <input
            type="text"
            name="obs_medicao[]"
            class="form-control form-control-sm obs-medicao"
            placeholder="Detalhes adicionais..."
          />
        </div>
      </div>
    </template>

    <template id="templateLinhaEquipamento">
      <div
        class="equipamento-observado-item row g-3 mb-3 p-3 border rounded align-items-start"
      >
        <div class="col-md-3">
          <label class="form-label form-label-sm">Tipo de Equipamento:*</label>
          <select
            name="tipo_equipamento_observado[]"
            class="form-select form-select-sm tipo-equipamento-observado"
            required
          >
            <option value="">Selecione...</option>
            <option value="Transformador de Força">
              Transformador de Força
            </option>
            <option value="Transformador Auxiliar">
              Transformador Auxiliar
            </option>
            <option value="Chave Seccionadora">Chave Seccionadora</option>
            <option value="Chave Fusível">Chave Fusível</option>
            <option value="Religador">Religador</option>
            <option value="Disjuntor">Disjuntor</option>
            <option value="Para-raio">Para-raio</option>
            <option value="Banco de Capacitor">Banco de Capacitor</option>
            <option value="TP">TP (Transformador de Potencial)</option>
            <option value="TC">TC (Transformador de Corrente)</option>
            <option value="Painel de Comando">Painel de Comando</option>
            <option value="Painel de Proteção">Painel de Proteção</option>
            <option value="Estrutura Metálica">Estrutura Metálica</option>
            <option value="Isolador">Isolador</option>
            <option value="Outro">Outro (especificar em obs.)</option>
          </select>
        </div>
        <div class="col-md-2">
          <label class="form-label form-label-sm"
            >TAG Equipamento (Opcional):</label
          >
          <input
            type="text"
            name="tag_equipamento_observado[]"
            class="form-control form-control-sm tag-equipamento-observado"
            placeholder="Ex: T-01"
          />
        </div>
        <div class="col-md-3">
          <label class="form-label form-label-sm"
            >Fotos (Opcional, máx. 5):</label
          >
          <input
            type="file"
            name="fotos_equipamento_observado[]"
            class="form-control form-control-sm fotos-equipamento-input"
            accept="image/*"
            multiple
          />
          <div
            class="fotos-equipamento-preview-container mt-1 d-flex flex-wrap gap-1"
          ></div>
          <small
            class="form-text text-muted d-block text-center mt-1 fotos-equipamento-count"
            >0 de 5 fotos selecionadas.</small
          >
        </div>
        <div class="col-md-3">
          <label class="form-label form-label-sm">Observação (Opcional):</label>
          <input
            type="text"
            name="obs_equipamento_observado[]"
            class="form-control form-control-sm obs-equipamento-observado"
            placeholder="Detalhes adicionais..."
          />
        </div>
        <div
          class="col-md-1 d-flex align-items-center justify-content-end pt-md-4"
        >
          <button
            type="button"
            class="btn btn-danger btn-sm btn-remover-equipamento-observado"
            title="Remover Equipamento Observado"
          >
            <span class="material-symbols-outlined">delete</span>
          </button>
        </div>
      </div>
    </template>

    {/* NOVO TEMPLATE PARA LINHA DE PONTO DE VERIFICAÇÃO ADICIONAL */}
    <template id="templateLinhaVerificacaoAdicional">
      <div
        class="verificacao-adicional-item row g-3 mb-3 p-3 border rounded align-items-start"
      >
        <div class="col-md-4">
          <label class="form-label form-label-sm">Item Verificado:*</label>
          <input
            type="text"
            name="item_verificado_adicional[]"
            class="form-control form-control-sm item-verificado-adicional"
            required
            placeholder="Ex: Checklist anterior, Acesso à SE"
          />
        </div>
        <div class="col-md-2">
          <label class="form-label form-label-sm">Estado:*</label>
          <select
            name="estado_item_adicional[]"
            class="form-select form-select-sm estado-item-adicional"
            required
          >
            <option value="OK">OK</option>
            <option value="Com Pendência">Com Pendência</option>
            <option value="Crítico">Crítico</option>
            <option value="N/A">N/A</option>
          </select>
        </div>
        <div class="col-md-2">
          <label class="form-label form-label-sm"
            >Nº Formulário Anterior (Opc.):</label
          >
          <input
            type="text"
            name="num_formulario_anterior_adicional[]"
            class="form-control form-control-sm num-formulario-anterior-adicional"
            placeholder="Número do formulário"
          />
        </div>
        <div class="col-md-3">
          <label class="form-label form-label-sm"
            >Detalhes da Observação:</label
          >
          <textarea
            name="detalhes_obs_adicional[]"
            class="form-control form-control-sm detalhes-obs-adicional"
            rows="1"
            placeholder="Estado: OK"
          ></textarea>
        </div>
        <div
          class="col-md-1 d-flex align-items-center justify-content-end pt-md-4"
        >
          <button
            type="button"
            class="btn btn-danger btn-sm btn-remover-verificacao-adicional"
            title="Remover Ponto de Verificação"
          >
            <span class="material-symbols-outlined">delete</span>
          </button>
        </div>
      </div>
    </template>

    <template id="templateFotoItemPreview">
      <div class="foto-preview-item-wrapper">
        <img
          src="#"
          class="img-thumbnail foto-preview-item-img"
          alt="Preview"
        />
        <button
          type="button"
          class="btn btn-icon btn-danger btn-sm btn-delete-foto-item-preview"
          title="Remover esta foto"
        >
          <span class="material-symbols-outlined">close</span>
        </button>
      </div>
    </template>

    <script
      src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"
      integrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz"
      crossorigin="anonymous"
    ></script>
    <script src="/scripts/subestacoes/inspecoes-checklist-subestacoes.js"></script>
  </body>
</html>
