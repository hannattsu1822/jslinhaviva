<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title><%= pageTitle %></title>

    <!-- Bibliotecas Externas -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bulma@0.9.4/css/bulma.min.css">
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@20..48,100..700,0..1,-50..200">
    <script src="https://cdn.jsdelivr.net/npm/echarts@5/dist/echarts.min.js"></script>

    <style>
        body { background-color: #f5f7fa; }
        
        .box {
            height: 100%;
            border-radius: 12px;
            border: 1px solid #eef0f5;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
            transition: transform 0.2s;
        }
        .box:hover { transform: translateY(-2px); }

        .material-symbols-outlined { vertical-align: bottom; }
        .kpi-icon { font-size: 48px !important; margin-bottom: 10px; }

        .chart-section {
            background: white;
            padding: 20px;
            border-radius: 12px;
            border: 1px solid #eef0f5;
            box-shadow: 0 4px 15px rgba(0,0,0,0.08);
            margin-bottom: 20px;
        }
        .chart-wrapper {
            position: relative;
            height: 400px;
            width: 100%;
            overflow: hidden;
        }

        .diag-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px 0;
            border-bottom: 1px solid #f0f0f0;
        }
        .diag-item:last-child { border-bottom: none; }
        .diag-label { display: flex; align-items: center; gap: 8px; color: #555; font-weight: 500; }
        .diag-value { 
            font-family: monospace; 
            background-color: #f8f9fa; 
            padding: 4px 8px; 
            border-radius: 4px; 
            color: #333; 
            font-weight: 600;
        }

        .live-indicator {
            display: inline-block;
            width: 10px;
            height: 10px;
            background-color: #48c774;
            border-radius: 50%;
            margin-right: 5px;
            animation: pulse 2s infinite;
        }
        @keyframes pulse {
            0% { box-shadow: 0 0 0 0 rgba(72, 199, 116, 0.7); }
            70% { box-shadow: 0 0 0 10px rgba(72, 199, 116, 0); }
            100% { box-shadow: 0 0 0 0 rgba(72, 199, 116, 0); }
        }

        @keyframes flashUpdate {
            0% { background-color: #e3f2fd; }
            100% { background-color: transparent; }
        }
        .updated-anim { animation: flashUpdate 1s ease-out; }
    </style>
</head>
<body>

<div class="container is-fluid p-5">
    
    <!-- CABEÇALHO -->
    <div class="level mb-5">
        <div class="level-left">
            <div class="level-item">
                <div>
                    <p class="heading is-size-6 has-text-grey">
                        <span class="icon-text">
                            <span class="icon"><span class="material-symbols-outlined">router</span></span>
                            <span>Monitoramento em Tempo Real</span>
                        </span>
                    </p>
                    <h1 class="title is-3 has-text-link-dark mb-1"><%= device.local_tag %></h1>
                    <p class="subtitle is-6">Serial Number: <strong><%= device.serial_number %></strong></p>
                </div>
            </div>
        </div>
        <div class="level-right">
            <div class="level-item">
                <a href="/gerenciar-dispositivos" class="button is-white shadow-sm">
                    <span class="icon"><span class="material-symbols-outlined">arrow_back</span></span>
                    <span>Voltar</span>
                </a>
            </div>
        </div>
    </div>

    <!-- KPI CARDS -->
    <div class="columns is-multiline mb-4">
        <div class="column is-3-desktop is-6-tablet">
            <div class="box has-text-centered" id="box-temp">
                <span class="material-symbols-outlined kpi-icon has-text-link">device_thermostat</span>
                <p class="heading mt-2">Temperatura</p>
                <p class="title is-2 has-text-weight-bold">
                    <span id="latest-temp">--</span><span class="is-size-4">°C</span>
                </p>
                <p class="is-size-7 has-text-grey" id="latest-timestamp">Aguardando...</p>
            </div>
        </div>
        <div class="column is-3-desktop is-6-tablet">
            <div class="box has-text-centered">
                <span class="material-symbols-outlined kpi-icon has-text-success">wifi</span>
                <p class="heading mt-2">Conexão</p>
                <p class="title is-4 has-text-weight-bold" id="connection-status-text">Verificando...</p>
                <p class="is-size-7 has-text-grey" id="diag-wifi-rssi">RSSI: --</p>
            </div>
        </div>
        <div class="column is-3-desktop is-6-tablet">
            <div class="box has-text-centered">
                <span class="material-symbols-outlined kpi-icon has-text-warning">bolt</span>
                <p class="heading mt-2">Energia</p>
                <p class="title is-5 has-text-weight-bold mt-2" id="diag-power-source">Verificando...</p>
                <p class="is-size-7 has-text-grey" id="diag-battery-voltage">Bateria: --</p>
            </div>
        </div>
        <div class="column is-3-desktop is-6-tablet">
            <div class="box has-text-centered">
                <span class="material-symbols-outlined kpi-icon has-text-danger">notifications_active</span>
                <p class="heading mt-2">Alarmes</p>
                <p class="title is-2 has-text-weight-bold" id="active-alarms-count">0</p>
                <p class="is-size-7 has-text-grey" id="alarm-subtitle">Normal</p>
            </div>
        </div>
    </div>

    <!-- GRÁFICO EM EVIDÊNCIA -->
    <div class="chart-section">
        <div class="level mb-4">
            <div class="level-left">
                <h3 class="title is-5 mb-0">
                    <span class="live-indicator"></span>
                    Histórico de Temperatura
                </h3>
            </div>
            <div class="level-right">
                <span class="tag is-light">Tempo Real</span>
            </div>
        </div>
        
        <div class="chart-wrapper">
            <div id="loader-historico" class="is-flex is-justify-content-center is-align-items-center" style="height: 100%; position: absolute; width: 100%; background: white; z-index: 10;">
                <div class="has-text-centered">
                    <span class="material-symbols-outlined is-size-1 has-text-grey-light spin">refresh</span>
                    <p class="has-text-grey mt-2">Carregando gráfico...</p>
                </div>
            </div>
            <div id="graficoHistorico" style="width: 100%; height: 100%;"></div>
        </div>
    </div>

    <!-- DETALHES TÉCNICOS E ESTATÍSTICAS -->
    <div class="columns is-multiline">
        <div class="column is-4">
            <div class="box">
                <h3 class="title is-5 mb-4">
                    <span class="icon-text">
                        <span class="icon has-text-info"><span class="material-symbols-outlined">query_stats</span></span>
                        <span>Estatísticas (Hoje)</span>
                    </span>
                </h3>
                <div class="content">
                    <div class="diag-item">
                        <span class="diag-label"><span class="material-symbols-outlined has-text-info">arrow_downward</span> Mínima</span>
                        <span class="diag-value" id="stat-today-min">-- °C</span>
                    </div>
                    <div class="diag-item">
                        <span class="diag-label"><span class="material-symbols-outlined has-text-info">functions</span> Média</span>
                        <span class="diag-value" id="stat-today-avg">-- °C</span>
                    </div>
                    <div class="diag-item">
                        <span class="diag-label"><span class="material-symbols-outlined has-text-info">arrow_upward</span> Máxima</span>
                        <span class="diag-value" id="stat-today-max">-- °C</span>
                    </div>
                </div>
            </div>
        </div>

        <div class="column is-8">
            <div class="box">
                <h3 class="title is-5 mb-4">
                    <span class="icon-text">
                        <span class="icon has-text-primary"><span class="material-symbols-outlined">developer_board</span></span>
                        <span>Diagnóstico Técnico</span>
                    </span>
                </h3>
                <div class="columns is-multiline">
                    <div class="column is-6">
                        <div class="diag-item">
                            <span class="diag-label"><span class="material-symbols-outlined">thermostat</span> Temp. Interna</span>
                            <span class="diag-value" id="diag-internal-temp">--</span>
                        </div>
                        <div class="diag-item">
                            <span class="diag-label"><span class="material-symbols-outlined">lan</span> Endereço IP</span>
                            <span class="diag-value" id="diag-ip-address">--</span>
                        </div>
                        <div class="diag-item">
                            <span class="diag-label"><span class="material-symbols-outlined">memory</span> Firmware</span>
                            <span class="diag-value" id="diag-firmware-version">--</span>
                        </div>
                        <div class="diag-item">
                            <span class="diag-label"><span class="material-symbols-outlined">update</span> Última Comunicação</span>
                            <span class="diag-value" id="diag-last-packet">--</span>
                        </div>
                    </div>
                    <div class="column is-6">
                        <div class="diag-item">
                            <span class="diag-label"><span class="material-symbols-outlined">fingerprint</span> Device ID</span>
                            <span class="diag-value"><%= device.id %></span>
                        </div>
                        <div class="diag-item">
                            <span class="diag-label"><span class="material-symbols-outlined">qr_code_2</span> MAC Address</span>
                            <span class="diag-value" id="diag-mac-address">--</span>
                        </div>
                        <div class="diag-item">
                            <span class="diag-label"><span class="material-symbols-outlined">signal_wifi_4_bar</span> Sinal Wi-Fi</span>
                            <span class="diag-value" id="diag-wifi-detail">--</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

</div>

<!-- LÓGICA JAVASCRIPT -->
<script>
    const serialNumber = "<%= serialNumber %>";
    let historicoChartInstance = null;
    
    // BUFFER LOCAL DE DADOS (O segredo para o gráfico funcionar bem)
    let dadosGraficoBuffer = []; 

    console.log("Painel Iniciado para SN:", serialNumber);

    document.addEventListener("DOMContentLoaded", () => {
        inicializarPainel();
    });

    function inicializarPainel() {
        iniciarWebSocket();
        carregarLeiturasIniciais(); // Carrega histórico do SQL
        carregarStatusInicial();
        carregarEstatisticasDetalhes();
    }

    // --- WEBSOCKET ---
    function iniciarWebSocket() {
        const protocol = window.location.protocol === "https:" ? "wss:" : "ws:";
        const host = window.location.host;
        const wsUrl = `${protocol}//${host}`;

        const socket = new WebSocket(wsUrl);

        socket.onopen = () => console.log("✅ WebSocket conectado!");
        
        socket.onmessage = (event) => {
            try {
                const msg = JSON.parse(event.data);
                if (msg.dados && msg.dados.serial_number && msg.dados.serial_number !== serialNumber) return;

                if (msg.type === "nova_leitura_logbox" || msg.type === "nova_leitura") {
                    atualizarPainelLeitura(msg.dados);
                } else if (msg.type === "atualizacao_status") {
                    atualizarPainelCompleto(msg.dados);
                }
            } catch (e) { console.error("Erro WS:", e); }
        };

        socket.onclose = () => setTimeout(iniciarWebSocket, 5000);
    }

    // --- API CALLS ---
    async function carregarLeiturasIniciais() {
        const loader = document.getElementById("loader-historico");
        const chartEl = document.getElementById("graficoHistorico");
        try {
            const response = await fetch(`/api/logbox-device/${serialNumber}/leituras`);
            let data = { labels: [], temperaturas: [] };
            
            if (response.ok) {
                data = await response.json();
            }
            
            // Converte dados da API para o formato do Buffer Local [timestamp, valor]
            dadosGraficoBuffer = (data.labels || []).map((label, index) => {
                let timestamp;
                if (typeof label === 'string' && label.includes('/')) {
                    const parts = label.split(/[\/\s:]/);
                    timestamp = new Date(parts[2], parts[1] - 1, parts[0], parts[3] || 0, parts[4] || 0, parts[5] || 0).getTime();
                } else {
                    timestamp = new Date(label).getTime();
                }
                return [timestamp, data.temperaturas[index]];
            });

            if (loader) loader.style.display = "none";
            if (chartEl) chartEl.style.display = "block";
            
            // Inicializa o gráfico com o que veio do SQL
            inicializarGrafico();
            
        } catch (error) {
            console.error("Erro ao carregar leituras:", error);
            if (loader) loader.style.display = "none";
            if (chartEl) chartEl.style.display = "block";
            inicializarGrafico(); // Inicia vazio se der erro
        }
    }

    async function carregarStatusInicial() {
        try {
            const response = await fetch(`/api/logbox-device/${serialNumber}/status`);
            if (response.ok) {
                const data = await response.json();
                const statusData = data.status || data;
                atualizarPainelCompleto(statusData);
            }
            
            const latestResp = await fetch(`/api/logbox-device/${serialNumber}/latest`);
            if (latestResp.ok) {
                const latest = await latestResp.json();
                if (latest && latest.payload) {
                    const payload = JSON.parse(latest.payload);
                    const temp = extrairTemperatura(payload);
                    if (temp !== null) atualizarTexto("latest-temp", temp.toFixed(1));
                    atualizarTexto("latest-timestamp", `Em: ${new Date(latest.timestamp_leitura).toLocaleString("pt-BR")}`);
                }
            }
        } catch (e) { console.error(e); }
    }

    async function carregarEstatisticasDetalhes() {
        try {
            const res = await fetch(`/api/logbox-device/${serialNumber}/stats-detail`);
            if (res.ok) {
                const stats = await res.json();
                atualizarTexto("stat-today-min", `${stats.today.min} °C`);
                atualizarTexto("stat-today-avg", `${stats.today.avg} °C`);
                atualizarTexto("stat-today-max", `${stats.today.max} °C`);
            }
        } catch (e) { console.error(e); }
    }

    // --- ATUALIZAÇÃO UI ---
    function atualizarPainelCompleto(status) {
        if (!status) return;

        const connEl = document.getElementById("connection-status-text");
        if (connEl) {
            const isOnline = status.connection_status !== "offline";
            connEl.textContent = isOnline ? "Online" : "Offline";
            connEl.className = isOnline ? "title is-4 has-text-weight-bold has-text-success" : "title is-4 has-text-weight-bold has-text-danger";
        }

        const rssi = detectarValor(status, ['lqi', 'rssi', 'signal', 'wifi_signal']);
        atualizarTexto("diag-wifi-rssi", `RSSI: ${rssi || "--"} dBm`);
        atualizarTexto("diag-wifi-detail", `${rssi || "--"} dBm`);

        const tensao = detectarValor(status, ['ch_analog_2', 'supply_voltage', 'input_voltage']);
        const powerInfo = getPowerSourceStatus(tensao);
        atualizarTexto("diag-power-source", powerInfo.text);

        const bat = detectarValor(status, ['ch_analog_3', 'battery', 'battery_voltage', 'vbat']);
        atualizarTexto("diag-battery-voltage", `Bateria: ${bat ? parseFloat(bat).toFixed(2) : "--"} V`);

        const tempInt = detectarValor(status, ['temperature', 'internal_temperature', 'temp_int', 'mcu_temp']);
        atualizarTexto("diag-internal-temp", tempInt ? `${parseFloat(tempInt).toFixed(1)} °C` : "--");

        const ip = detectarValor(status, ['ip', 'ip_address', 'net_ip', 'local_ip']);
        atualizarTexto("diag-ip-address", ip || "--");

        const fw = detectarValor(status, ['firmware_version', 'version', 'fw_version', 'fw']);
        atualizarTexto("diag-firmware-version", fw || "--");

        const mac = detectarValor(status, ['mac', 'mac_address', 'wifi_mac', 'device_mac']);
        atualizarTexto("diag-mac-address", mac || "--");

        const ts = status.timestamp || status.ts || new Date().toISOString();
        atualizarTexto("diag-last-packet", new Date(ts).toLocaleTimeString("pt-BR"));

        atualizarListaAlarmes(status.alarms);
    }

    function atualizarPainelLeitura(dados) {
        const temperatura = extrairTemperatura(dados);
        if (temperatura !== undefined && temperatura !== null) {
            const tempEl = document.getElementById("latest-temp");
            if (tempEl) {
                tempEl.textContent = temperatura.toFixed(1);
                const box = document.getElementById("box-temp");
                if (box) {
                    box.classList.remove("updated-anim");
                    void box.offsetWidth;
                    box.classList.add("updated-anim");
                }
            }
            // Atualiza o gráfico com o novo dado
            adicionarPontoGrafico(temperatura);
        }
        atualizarTexto("latest-timestamp", `Em: ${new Date().toLocaleString("pt-BR")}`);
        atualizarPainelCompleto(dados);
    }

    // --- GRÁFICO (LÓGICA ROBUSTA) ---
    function inicializarGrafico() {
        const container = document.getElementById("graficoHistorico");
        if (!container) return;
        
        if (historicoChartInstance) historicoChartInstance.dispose();

        historicoChartInstance = echarts.init(container);
        
        const option = {
            tooltip: {
                trigger: 'axis',
                backgroundColor: 'rgba(255, 255, 255, 0.95)',
                borderColor: '#ddd',
                borderWidth: 1,
                textStyle: { color: '#333' },
                formatter: params => {
                    if (!params[0]) return '';
                    const d = new Date(params[0].value[0]);
                    return `<strong>${d.toLocaleTimeString("pt-BR")}</strong><br/>Temp: <strong>${params[0].value[1].toFixed(1)} °C</strong>`;
                }
            },
            grid: { left: '40', right: '20', bottom: '30', top: '30', containLabel: true },
            xAxis: {
                type: 'time',
                boundaryGap: false,
                axisLine: { lineStyle: { color: '#ddd' } },
                axisLabel: { color: '#666' }
            },
            yAxis: {
                type: 'value',
                splitLine: { lineStyle: { type: 'dashed', color: '#eee' } },
                axisLabel: { formatter: '{value} °C', color: '#666' },
                scale: true // Ajusta escala automaticamente
            },
            series: [{
                name: 'Temperatura',
                type: 'line',
                smooth: true,
                showSymbol: false,
                data: dadosGraficoBuffer, // Usa o buffer global
                lineStyle: { color: '#3298dc', width: 3 },
                areaStyle: {
                    color: new echarts.graphic.LinearGradient(0, 0, 0, 1, [
                        { offset: 0, color: 'rgba(50, 152, 220, 0.4)' },
                        { offset: 1, color: 'rgba(50, 152, 220, 0.0)' }
                    ])
                }
            }]
        };
        historicoChartInstance.setOption(option);
        window.addEventListener("resize", () => historicoChartInstance && historicoChartInstance.resize());
    }

    function adicionarPontoGrafico(temperatura) {
        if (!historicoChartInstance) return;
        
        const now = new Date().getTime();
        
        // Adiciona ao buffer local
        dadosGraficoBuffer.push([now, temperatura]);
        
        // Mantém apenas os últimos 300 pontos para não pesar
        if (dadosGraficoBuffer.length > 300) {
            dadosGraficoBuffer.shift();
        }

        // Atualiza o gráfico com o buffer completo (mais seguro e rápido)
        historicoChartInstance.setOption({
            series: [{
                data: dadosGraficoBuffer
            }]
        });
    }

    // --- HELPERS ---
    function detectarValor(dados, chavesPossiveis) {
        if (!dados) return null;
        for (let chave of chavesPossiveis) {
            if (dados[chave] !== undefined && dados[chave] !== null && dados[chave] !== "") return dados[chave];
            if (dados[chave.toLowerCase()] !== undefined) return dados[chave.toLowerCase()];
            if (dados[chave.toUpperCase()] !== undefined) return dados[chave.toUpperCase()];
        }
        return null;
    }

    function extrairTemperatura(dados) {
        if (dados.ch_analog_1 !== undefined) return dados.ch_analog_1;
        if (dados.value_channels && Array.isArray(dados.value_channels)) return dados.value_channels[2];
        return null;
    }

    function atualizarTexto(id, texto) {
        const el = document.getElementById(id);
        if (el) el.textContent = texto;
    }

    function atualizarListaAlarmes(alarms) {
        const countEl = document.getElementById("active-alarms-count");
        const subEl = document.getElementById("alarm-subtitle");
        if (!countEl) return;
        let activeCount = 0;
        if (alarms) {
            activeCount = Array.isArray(alarms) 
                ? alarms.filter(a => a === 1).length 
                : Object.values(alarms).filter(v => v === true).length;
        }
        countEl.textContent = activeCount;
        if (subEl) subEl.textContent = activeCount > 0 ? `${activeCount} Alarme(s)` : "Sistema Normal";
        
        const box = countEl.closest('.box');
        if(activeCount > 0) {
            box.style.border = "2px solid #f14668";
            countEl.classList.add("has-text-danger");
        } else {
            box.style.border = "1px solid #eef0f5";
            countEl.classList.remove("has-text-danger");
        }
    }

    function getPowerSourceStatus(voltage) {
        if (voltage === undefined || voltage === null) return { text: "Verificando..." };
        return voltage > 9 ? { text: "Rede Elétrica" } : { text: "Apenas Bateria" };
    }
</script>

</body>
</html>
