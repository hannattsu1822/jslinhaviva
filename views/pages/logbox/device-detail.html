<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title><%= pageTitle %></title>

    <!-- Bibliotecas Externas -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bulma@0.9.4/css/bulma.min.css">
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@20..48,100..700,0..1,-50..200">
    <script src="https://cdn.jsdelivr.net/npm/echarts@5/dist/echarts.min.js"></script>

    <!-- ESTILOS CSS -->
    <style>
        .box {
            height: 100%;
            transition: transform 0.2s ease, box-shadow 0.2s ease;
            border-radius: 8px;
            box-shadow: 0 0.5em 1em -0.125em rgba(10, 10, 10, 0.1);
        }

        .box:hover {
            transform: translateY(-2px);
            box-shadow: 0 0.5em 1em -0.125em rgba(10, 10, 10, 0.2);
        }

        .chart-container {
            position: relative;
            width: 100%;
            overflow: hidden;
        }

        .tag {
            font-weight: 600;
        }

        .level-item .title {
            margin-bottom: 0 !important;
        }

        /* Animação de atualização */
        @keyframes highlight {
            0% { background-color: #e3f2fd; }
            100% { background-color: transparent; }
        }

        .updated-anim {
            animation: highlight 1s ease-out;
        }
        
        .material-symbols-outlined {
            vertical-align: bottom;
        }
    </style>
</head>
<body>
<div class="container is-fluid">
    <section class="section">

        <!-- CABEÇALHO -->
        <div class="level mb-5">
            <div class="level-left">
                <div class="level-item">
                    <div>
                        <p class="heading">
                            <span class="material-symbols-outlined">sensors</span>
                            Monitoramento
                        </p>
                        <p class="title is-3"><%= device.local_tag %></p>
                        <p class="subtitle is-6">SN: <strong><%= device.serial_number %></strong></p>
                    </div>
                </div>
            </div>

            <div class="level-right">
                <div class="level-item">
                    <a href="/gerenciar-dispositivos" class="button is-light">
                        <span class="icon">
                            <span class="material-symbols-outlined">arrow_back</span>
                        </span>
                        <span>Voltar</span>
                    </a>
                </div>
            </div>
        </div>

        <!-- CARDS DE KPI -->
        <div class="columns is-multiline mb-5">
            <!-- Temperatura -->
            <div class="column is-3">
                <div class="box has-text-centered" id="box-temp">
                    <span class="icon is-large has-text-link">
                        <span class="material-symbols-outlined" style="font-size: 48px;">device_thermostat</span>
                    </span>
                    <p class="heading mt-3">Temperatura Atual</p>
                    <p class="title is-4">
                        <span id="latest-temp">--</span>
                        <span class="is-size-5">°C</span>
                    </p>
                    <p class="help" id="latest-timestamp">Aguardando dados...</p>
                </div>
            </div>

            <!-- Conexão -->
            <div class="column is-3">
                <div class="box has-text-centered">
                    <span class="icon is-large has-text-success">
                        <span class="material-symbols-outlined" style="font-size: 48px;">signal_cellular_alt</span>
                    </span>
                    <p class="heading mt-3">Status da Conexão</p>
                    <p class="title is-4" id="connection-status-text">Verificando...</p>
                    <p class="help" id="diag-wifi-rssi">RSSI --</p>
                </div>
            </div>

            <!-- Energia -->
            <div class="column is-3">
                <div class="box has-text-centered">
                    <span class="icon is-large has-text-warning">
                        <span class="material-symbols-outlined" style="font-size: 48px;">power</span>
                    </span>
                    <p class="heading mt-3">Fonte de Energia</p>
                    <p class="title is-5" id="diag-power-source">Verificando...</p>
                    <p class="help" id="diag-battery-voltage">Bateria --</p>
                </div>
            </div>

            <!-- Alarmes -->
            <div class="column is-3">
                <div class="box has-text-centered">
                    <span class="icon is-large has-text-danger">
                        <span class="material-symbols-outlined" style="font-size: 48px;">warning</span>
                    </span>
                    <p class="heading mt-3">Alarmes Ativos</p>
                    <p class="title is-4" id="active-alarms-count">0</p>
                    <p class="help" id="alarm-subtitle">Nenhum alarme</p>
                </div>
            </div>
        </div>

        <!-- ESTATÍSTICAS E DIAGNÓSTICO -->
        <div class="columns is-multiline mb-5">
            <div class="column is-6">
                <div class="box">
                    <div class="level mb-4">
                        <div class="level-left">
                            <div class="level-item">
                                <span class="icon-text">
                                    <span class="icon"><span class="material-symbols-outlined">query_stats</span></span>
                                    <span class="title is-5">Estatísticas (Hoje)</span>
                                </span>
                            </div>
                        </div>
                    </div>

                    <div class="content">
                        <div class="level is-mobile">
                            <div class="level-left"><div class="level-item"><span>Mínima</span></div></div>
                            <div class="level-right"><div class="level-item"><strong id="stat-today-min">-- °C</strong></div></div>
                        </div>
                        <div class="level is-mobile">
                            <div class="level-left"><div class="level-item"><span>Média</span></div></div>
                            <div class="level-right"><div class="level-item"><strong id="stat-today-avg">-- °C</strong></div></div>
                        </div>
                        <div class="level is-mobile">
                            <div class="level-left"><div class="level-item"><span>Máxima</span></div></div>
                            <div class="level-right"><div class="level-item"><strong id="stat-today-max">-- °C</strong></div></div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="column is-6">
                <div class="box">
                    <div class="level mb-4">
                        <div class="level-left">
                            <div class="level-item">
                                <span class="icon-text">
                                    <span class="icon"><span class="material-symbols-outlined">developer_board</span></span>
                                    <span class="title is-5">Diagnóstico</span>
                                </span>
                            </div>
                        </div>
                    </div>

                    <div class="content">
                        <div class="level is-mobile mb-3">
                            <div class="level-left">
                                <div class="level-item">
                                    <span class="icon-text">
                                        <span class="icon has-text-danger"><span class="material-symbols-outlined">device_thermostat</span></span>
                                        <span>Temp. Interna</span>
                                    </span>
                                </div>
                            </div>
                            <div class="level-right"><div class="level-item"><span class="tag" id="diag-internal-temp">--</span></div></div>
                        </div>

                        <div class="level is-mobile mb-3">
                            <div class="level-left">
                                <div class="level-item">
                                    <span class="icon-text">
                                        <span class="icon has-text-link"><span class="material-symbols-outlined">public</span></span>
                                        <span>IP</span>
                                    </span>
                                </div>
                            </div>
                            <div class="level-right"><div class="level-item"><span class="tag" id="diag-ip-address">--</span></div></div>
                        </div>

                        <div class="level is-mobile mb-3">
                            <div class="level-left">
                                <div class="level-item">
                                    <span class="icon-text">
                                        <span class="icon"><span class="material-symbols-outlined">memory</span></span>
                                        <span>Firmware</span>
                                    </span>
                                </div>
                            </div>
                            <div class="level-right"><div class="level-item"><span class="tag" id="diag-firmware-version">--</span></div></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- GRÁFICO -->
        <div class="columns">
            <div class="column is-12">
                <div class="box">
                    <div class="level mb-4">
                        <div class="level-left">
                            <div class="level-item">
                                <span class="icon-text">
                                    <span class="icon"><span class="material-symbols-outlined">timeline</span></span>
                                    <span class="title is-5">Histórico de Temperatura</span>
                                </span>
                            </div>
                        </div>
                    </div>

                    <div class="chart-container" style="position: relative; height: 400px; min-height: 400px;">
                        <div id="loader-historico" class="has-text-centered py-6" style="position: absolute; width: 100%; top: 40%;">
                            <button class="button is-loading is-ghost is-large"></button>
                            <p class="mt-3">Carregando histórico...</p>
                        </div>
                        <div id="graficoHistorico" style="width: 100%; height: 100%; min-height: 400px; display: none;"></div>
                    </div>
                </div>
            </div>
        </div>

    </section>
</div>

<!-- LÓGICA JAVASCRIPT -->
<script>
    const serialNumber = "<%= serialNumber %>";
    let historicoChartInstance = null;

    console.log("Painel Iniciado para SN:", serialNumber);

    document.addEventListener("DOMContentLoaded", () => {
        inicializarPainel();
    });

    function inicializarPainel() {
        iniciarWebSocket();
        carregarLeiturasIniciais();
        carregarStatusInicial();
        carregarEstatisticasDetalhes();
    }

    // --- WEBSOCKET ---
    function iniciarWebSocket() {
        const protocol = window.location.protocol === "https:" ? "wss:" : "ws:";
        const host = window.location.host;
        const wsUrl = `${protocol}//${host}`;

        console.log(`Tentando conectar WebSocket em: ${wsUrl}`);
        const socket = new WebSocket(wsUrl);

        socket.onopen = () => {
            console.log("✅ WebSocket conectado com sucesso!");
        };

        socket.onmessage = (event) => {
            try {
                const msg = JSON.parse(event.data);
                
                // Filtra mensagens para garantir que é deste dispositivo
                if (msg.dados && msg.dados.serial_number && msg.dados.serial_number !== serialNumber) {
                    return;
                }

                if (msg.type === "nova_leitura_logbox" || msg.type === "nova_leitura") {
                    atualizarPainelLeitura(msg.dados);
                } else if (msg.type === "atualizacao_status") {
                    atualizarPainelCompleto(msg.dados);
                }
            } catch (e) {
                console.error("Erro ao processar mensagem WS:", e);
            }
        };

        socket.onclose = (event) => {
            console.warn("WebSocket desconectado. Tentando reconectar em 5s...", event.code);
            setTimeout(iniciarWebSocket, 5000);
        };

        socket.onerror = (err) => {
            console.error("Erro no WebSocket:", err);
        };
    }

    // --- CARREGAMENTO DE DADOS (API) ---
    async function carregarLeiturasIniciais() {
        const loader = document.getElementById("loader-historico");
        const chartContainer = document.getElementById("graficoHistorico");

        try {
            if (loader) loader.style.display = "block";
            if (chartContainer) chartContainer.style.display = "none";

            const response = await fetch(`/api/logbox-device/${serialNumber}/leituras`);
            if (!response.ok) throw new Error(`HTTP Error: ${response.status}`);

            const data = await response.json();
            gerarGraficoHistorico(data);

            if (loader) loader.style.display = "none";
            if (chartContainer) chartContainer.style.display = "block";
        } catch (error) {
            console.error("Erro ao carregar leituras:", error);
            if (loader) loader.innerHTML = `<p class="has-text-danger">Erro ao carregar gráfico.</p>`;
        }
    }

    async function carregarStatusInicial() {
        try {
            const response = await fetch(`/api/logbox-device/${serialNumber}/status`);
            if (!response.ok) throw new Error("Falha ao buscar status");

            const data = await response.json();
            const statusData = data.status || data;
            
            // DEBUG: Verifique no console do navegador o que está chegando aqui
            console.log("DEBUG - Status Inicial Recebido:", statusData);
            
            atualizarPainelCompleto(statusData);
            
            const latestResp = await fetch(`/api/logbox-device/${serialNumber}/latest`);
            if (latestResp.ok) {
                const latest = await latestResp.json();
                if (latest && latest.payload) {
                    const payload = JSON.parse(latest.payload);
                    const temp = extrairTemperatura(payload);
                    if (temp !== null) atualizarTexto("latest-temp", temp.toFixed(1));
                    atualizarTexto("latest-timestamp", `Em: ${new Date(latest.timestamp_leitura).toLocaleString("pt-BR")}`);
                }
            }
        } catch (error) {
            console.error("Erro ao carregar status:", error);
        }
    }

    async function carregarEstatisticasDetalhes() {
        try {
            const res = await fetch(`/api/logbox-device/${serialNumber}/stats-detail`);
            if (res.ok) {
                const stats = await res.json();
                atualizarTexto("stat-today-min", `${stats.today.min} °C`);
                atualizarTexto("stat-today-avg", `${stats.today.avg} °C`);
                atualizarTexto("stat-today-max", `${stats.today.max} °C`);
            }
        } catch (e) {
            console.error("Erro stats:", e);
        }
    }

    // --- ATUALIZAÇÃO DA UI ---
    function atualizarPainelCompleto(status) {
        if (!status) return;

        // 1. Status Conexão
        const connEl = document.getElementById("connection-status-text");
        if (connEl) {
            const isOnline = status.connection_status !== "offline";
            connEl.textContent = isOnline ? "Online" : "Offline";
            connEl.className = isOnline ? "title is-4 has-text-success" : "title is-4 has-text-danger";
        }

        // 2. Wi-Fi / RSSI (Tenta vários nomes possíveis)
        const rssi = status.lqi || status.rssi || status.signal;
        atualizarTexto("diag-wifi-rssi", `RSSI: ${rssi || "--"} dBm`);
        
        // 3. Fonte de Energia
        const tensaoEntrada = status.ch_analog_2 !== undefined ? status.ch_analog_2 : status.supply_voltage;
        const powerInfo = getPowerSourceStatus(tensaoEntrada);
        atualizarTexto("diag-power-source", powerInfo.text);

        // 4. Bateria
        const bateria = status.ch_analog_3 !== undefined ? status.ch_analog_3 : status.battery;
        atualizarTexto("diag-battery-voltage", `Bateria: ${bateria ? parseFloat(bateria).toFixed(2) : "--"} V`);

        // 5. Temperatura Interna (Tenta vários nomes possíveis)
        const tempInterna = status.temperature || status.internal_temperature || status.temp_int || status.mcu_temp;
        atualizarTexto("diag-internal-temp", `${tempInterna ? parseFloat(tempInterna).toFixed(1) : "--"} °C`);

        // 6. IP (Tenta vários nomes possíveis)
        const ip = status.ip || status.ip_address || status.IP || "--";
        atualizarTexto("diag-ip-address", ip);

        // 7. Firmware (Tenta vários nomes possíveis)
        const fw = status.firmware_version || status.version || status.fw_version || "--";
        atualizarTexto("diag-firmware-version", fw);

        atualizarListaAlarmes(status.alarms);
    }

    function atualizarPainelLeitura(dados) {
        const temperatura = extrairTemperatura(dados);

        if (temperatura !== undefined && temperatura !== null) {
            const tempEl = document.getElementById("latest-temp");
            if (tempEl) {
                tempEl.textContent = temperatura.toFixed(1);
                const box = document.getElementById("box-temp");
                if (box) {
                    box.classList.remove("updated-anim");
                    void box.offsetWidth; 
                    box.classList.add("updated-anim");
                }
            }
            atualizarGraficoTempoReal(temperatura);
        }

        atualizarTexto("latest-timestamp", `Em: ${new Date().toLocaleString("pt-BR")}`);

        if (dados.ch_analog_2 !== undefined) {
            const powerInfo = getPowerSourceStatus(dados.ch_analog_2);
            atualizarTexto("diag-power-source", powerInfo.text);
        }
    }

    // --- GRÁFICOS ---
    function gerarGraficoHistorico(dados) {
        const container = document.getElementById("graficoHistorico");
        if (!container || !dados.labels || dados.labels.length === 0) {
            if (container) container.innerHTML = '<p class="has-text-centered py-6">Sem dados históricos disponíveis.</p>';
            return;
        }

        if (historicoChartInstance) {
            historicoChartInstance.dispose();
        }

        const chartData = dados.labels.map((label, index) => {
            return [parseDataBr(label), dados.temperaturas[index]];
        });

        historicoChartInstance = echarts.init(container);

        const option = {
            tooltip: {
                trigger: 'axis',
                formatter: params => {
                    if (!params[0]) return '';
                    const d = new Date(params[0].value[0]);
                    return `${d.toLocaleString("pt-BR")}<br/>Temp: <strong>${params[0].value[1].toFixed(1)} °C</strong>`;
                }
            },
            grid: { left: '3%', right: '4%', bottom: '3%', containLabel: true },
            xAxis: {
                type: 'time',
                boundaryGap: false,
                axisLabel: {
                    formatter: value => {
                        const date = new Date(value);
                        return `${date.getHours().toString().padStart(2, '0')}:${date.getMinutes().toString().padStart(2, '0')}`;
                    }
                }
            },
            yAxis: {
                type: 'value',
                axisLabel: { formatter: '{value} °C' },
                scale: true
            },
            series: [{
                name: 'Temperatura',
                type: 'line',
                smooth: true,
                showSymbol: false,
                data: chartData,
                lineStyle: { color: '#3273dc', width: 2 },
                areaStyle: {
                    color: new echarts.graphic.LinearGradient(0, 0, 0, 1, [
                        { offset: 0, color: 'rgba(50, 115, 220, 0.3)' },
                        { offset: 1, color: 'rgba(50, 115, 220, 0.05)' }
                    ])
                }
            }]
        };

        historicoChartInstance.setOption(option);
        window.addEventListener("resize", () => historicoChartInstance && historicoChartInstance.resize());
    }

    function atualizarGraficoTempoReal(temperatura) {
        if (!historicoChartInstance) return;

        const now = new Date().getTime();
        const option = historicoChartInstance.getOption();

        if (option && option.series && option.series[0]) {
            const data = option.series[0].data;
            data.push([now, temperatura]);
            if (data.length > 200) data.shift();

            historicoChartInstance.setOption({
                series: [{ data: data }]
            });
        }
    }

    // --- UTILITÁRIOS ---
    function extrairTemperatura(dados) {
        if (dados.ch_analog_1 !== undefined) return dados.ch_analog_1;
        if (dados.value_channels && Array.isArray(dados.value_channels)) return dados.value_channels[2];
        return null;
    }

    function atualizarTexto(id, texto) {
        const el = document.getElementById(id);
        if (el) el.textContent = texto;
    }

    function atualizarListaAlarmes(alarms) {
        const countEl = document.getElementById("active-alarms-count");
        const subEl = document.getElementById("alarm-subtitle");
        if (!countEl) return;

        let activeCount = 0;
        if (alarms) {
            activeCount = Array.isArray(alarms) 
                ? alarms.filter(a => a === 1).length 
                : Object.values(alarms).filter(v => v === true).length;
        }

        countEl.textContent = activeCount;
        if (subEl) subEl.textContent = activeCount > 0 ? `${activeCount} alarme(s)` : "Nenhum alarme";
    }

    function getPowerSourceStatus(voltage) {
        if (voltage === undefined || voltage === null) return { text: "Verificando..." };
        return voltage > 9 ? { text: "Rede Elétrica" } : { text: "Apenas Bateria" };
    }

    function parseDataBr(dataString) {
        if (typeof dataString === 'string' && dataString.includes('/')) {
            const parts = dataString.split(/[\/\s:]/);
            return new Date(parts[2], parts[1] - 1, parts[0], parts[3] || 0, parts[4] || 0, parts[5] || 0).getTime();
        }
        return new Date(dataString).getTime();
    }
</script>
</body>
</html>
