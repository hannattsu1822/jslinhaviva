<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title><%= pageTitle %></title>

    <!-- Bibliotecas Externas -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bulma@0.9.4/css/bulma.min.css">
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@20..48,100..700,0..1,-50..200">
    <script src="https://cdn.jsdelivr.net/npm/echarts@5/dist/echarts.min.js"></script>

    <style>
        /* Estilos Personalizados */
        body {
            background-color: #f5f7fa;
        }
        
        .box {
            height: 100%;
            transition: all 0.3s cubic-bezier(0.25, 0.8, 0.25, 1);
            border-radius: 12px;
            border: 1px solid #eef0f5;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
        }

        .box:hover {
            transform: translateY(-3px);
            box-shadow: 0 10px 20px rgba(0,0,0,0.1);
        }

        .material-symbols-outlined {
            vertical-align: bottom;
        }

        .kpi-icon {
            font-size: 48px !important;
            margin-bottom: 10px;
        }

        .diag-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px 0;
            border-bottom: 1px solid #f0f0f0;
        }

        .diag-item:last-child {
            border-bottom: none;
        }

        .diag-label {
            display: flex;
            align-items: center;
            gap: 8px;
            color: #555;
            font-weight: 500;
        }

        .diag-value {
            font-family: monospace;
            font-size: 0.95rem;
            background-color: #f8f9fa;
            padding: 2px 8px;
            border-radius: 4px;
            color: #333;
        }

        /* Animação de atualização de dados */
        @keyframes flashUpdate {
            0% { background-color: #e3f2fd; }
            100% { background-color: transparent; }
        }

        .updated-anim {
            animation: flashUpdate 1.5s ease-out;
        }

        .chart-wrapper {
            position: relative;
            height: 450px;
            width: 100%;
            overflow: hidden;
        }
    </style>
</head>
<body>

<div class="container is-fluid p-5">
    
    <!-- CABEÇALHO -->
    <div class="level mb-5">
        <div class="level-left">
            <div class="level-item">
                <div>
                    <p class="heading is-size-6 has-text-grey">
                        <span class="icon-text">
                            <span class="icon"><span class="material-symbols-outlined">router</span></span>
                            <span>Monitoramento de Dispositivo</span>
                        </span>
                    </p>
                    <h1 class="title is-3 has-text-link-dark mb-1"><%= device.local_tag %></h1>
                    <p class="subtitle is-6">Serial Number: <strong><%= device.serial_number %></strong></p>
                </div>
            </div>
        </div>

        <div class="level-right">
            <div class="level-item">
                <a href="/gerenciar-dispositivos" class="button is-white shadow-sm">
                    <span class="icon">
                        <span class="material-symbols-outlined">arrow_back</span>
                    </span>
                    <span>Voltar</span>
                </a>
            </div>
        </div>
    </div>

    <!-- KPI CARDS (Indicadores Principais) -->
    <div class="columns is-multiline mb-2">
        <!-- Temperatura -->
        <div class="column is-3-desktop is-6-tablet">
            <div class="box has-text-centered" id="box-temp">
                <span class="material-symbols-outlined kpi-icon has-text-link">device_thermostat</span>
                <p class="heading mt-2">Temperatura Atual</p>
                <p class="title is-2 has-text-weight-bold">
                    <span id="latest-temp">--</span><span class="is-size-4">°C</span>
                </p>
                <p class="is-size-7 has-text-grey" id="latest-timestamp">Aguardando dados...</p>
            </div>
        </div>

        <!-- Conexão -->
        <div class="column is-3-desktop is-6-tablet">
            <div class="box has-text-centered">
                <span class="material-symbols-outlined kpi-icon has-text-success">wifi</span>
                <p class="heading mt-2">Status da Conexão</p>
                <p class="title is-4 has-text-weight-bold" id="connection-status-text">Verificando...</p>
                <p class="is-size-7 has-text-grey" id="diag-wifi-rssi">RSSI: --</p>
            </div>
        </div>

        <!-- Energia -->
        <div class="column is-3-desktop is-6-tablet">
            <div class="box has-text-centered">
                <span class="material-symbols-outlined kpi-icon has-text-warning">bolt</span>
                <p class="heading mt-2">Fonte de Energia</p>
                <p class="title is-5 has-text-weight-bold mt-2" id="diag-power-source">Verificando...</p>
                <p class="is-size-7 has-text-grey" id="diag-battery-voltage">Bateria: --</p>
            </div>
        </div>

        <!-- Alarmes -->
        <div class="column is-3-desktop is-6-tablet">
            <div class="box has-text-centered">
                <span class="material-symbols-outlined kpi-icon has-text-danger">notifications_active</span>
                <p class="heading mt-2">Alarmes Ativos</p>
                <p class="title is-2 has-text-weight-bold" id="active-alarms-count">0</p>
                <p class="is-size-7 has-text-grey" id="alarm-subtitle">Sistema Normal</p>
            </div>
        </div>
    </div>

    <div class="columns is-multiline">
        
        <!-- COLUNA ESQUERDA: ESTATÍSTICAS -->
        <div class="column is-4">
            <div class="box">
                <div class="is-flex is-justify-content-space-between is-align-items-center mb-4">
                    <h3 class="title is-5 mb-0">
                        <span class="icon-text">
                            <span class="icon has-text-info"><span class="material-symbols-outlined">query_stats</span></span>
                            <span>Estatísticas (Hoje)</span>
                        </span>
                    </h3>
                </div>
                
                <div class="content">
                    <div class="diag-item">
                        <span class="diag-label"><span class="material-symbols-outlined has-text-info">arrow_downward</span> Mínima</span>
                        <span class="diag-value has-text-weight-bold" id="stat-today-min">-- °C</span>
                    </div>
                    <div class="diag-item">
                        <span class="diag-label"><span class="material-symbols-outlined has-text-info">functions</span> Média</span>
                        <span class="diag-value has-text-weight-bold" id="stat-today-avg">-- °C</span>
                    </div>
                    <div class="diag-item">
                        <span class="diag-label"><span class="material-symbols-outlined has-text-info">arrow_upward</span> Máxima</span>
                        <span class="diag-value has-text-weight-bold" id="stat-today-max">-- °C</span>
                    </div>
                </div>
            </div>
        </div>

        <!-- COLUNA DIREITA: DIAGNÓSTICO TÉCNICO -->
        <div class="column is-8">
            <div class="box">
                <div class="is-flex is-justify-content-space-between is-align-items-center mb-4">
                    <h3 class="title is-5 mb-0">
                        <span class="icon-text">
                            <span class="icon has-text-primary"><span class="material-symbols-outlined">developer_board</span></span>
                            <span>Diagnóstico Técnico</span>
                        </span>
                    </h3>
                </div>

                <div class="columns is-multiline">
                    <div class="column is-6">
                        <div class="diag-item">
                            <span class="diag-label"><span class="material-symbols-outlined">thermostat</span> Temp. Interna (MCU)</span>
                            <span class="diag-value" id="diag-internal-temp">--</span>
                        </div>
                        <div class="diag-item">
                            <span class="diag-label"><span class="material-symbols-outlined">lan</span> Endereço IP</span>
                            <span class="diag-value" id="diag-ip-address">--</span>
                        </div>
                        <div class="diag-item">
                            <span class="diag-label"><span class="material-symbols-outlined">memory</span> Firmware</span>
                            <span class="diag-value" id="diag-firmware-version">--</span>
                        </div>
                    </div>
                    <div class="column is-6">
                        <div class="diag-item">
                            <span class="diag-label"><span class="material-symbols-outlined">fingerprint</span> Device ID (Banco)</span>
                            <span class="diag-value"><%= device.id %></span>
                        </div>
                        <div class="diag-item">
                            <span class="diag-label"><span class="material-symbols-outlined">qr_code_2</span> MAC Address</span>
                            <span class="diag-value" id="diag-mac-address">--</span>
                        </div>
                        <div class="diag-item">
                            <span class="diag-label"><span class="material-symbols-outlined">update</span> Último Pacote</span>
                            <span class="diag-value" id="diag-last-packet">--</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- GRÁFICO -->
    <div class="columns">
        <div class="column is-12">
            <div class="box">
                <h3 class="title is-5 mb-4">
                    <span class="icon-text">
                        <span class="icon has-text-link"><span class="material-symbols-outlined">timeline</span></span>
                        <span>Histórico de Temperatura</span>
                    </span>
                </h3>
                
                <div class="chart-wrapper">
                    <div id="loader-historico" class="is-flex is-justify-content-center is-align-items-center" style="height: 100%;">
                        <div class="has-text-centered">
                            <span class="material-symbols-outlined is-size-1 has-text-grey-light spin">refresh</span>
                            <p class="has-text-grey mt-2">Carregando dados...</p>
                        </div>
                    </div>
                    <div id="graficoHistorico" style="width: 100%; height: 100%; display: none;"></div>
                </div>
            </div>
        </div>
    </div>

</div>

<!-- LÓGICA JAVASCRIPT -->
<script>
    const serialNumber = "<%= serialNumber %>";
    let historicoChartInstance = null;

    console.log("Painel Iniciado para SN:", serialNumber);

    document.addEventListener("DOMContentLoaded", () => {
        inicializarPainel();
    });

    function inicializarPainel() {
        iniciarWebSocket();
        carregarLeiturasIniciais();
        carregarStatusInicial();
        carregarEstatisticasDetalhes();
    }

    // --- FUNÇÃO INTELIGENTE PARA ENCONTRAR DADOS ---
    // Procura por várias chaves possíveis dentro do objeto de dados
    function detectarValor(dados, chavesPossiveis) {
        if (!dados) return null;
        for (let chave of chavesPossiveis) {
            // Verifica se a chave existe diretamente
            if (dados[chave] !== undefined && dados[chave] !== null && dados[chave] !== "") {
                return dados[chave];
            }
            // Verifica se existe em minúsculo ou maiúsculo
            const lowerKey = chave.toLowerCase();
            const upperKey = chave.toUpperCase();
            if (dados[lowerKey] !== undefined) return dados[lowerKey];
            if (dados[upperKey] !== undefined) return dados[upperKey];
        }
        return null;
    }

    // --- WEBSOCKET ---
    function iniciarWebSocket() {
        const protocol = window.location.protocol === "https:" ? "wss:" : "ws:";
        const host = window.location.host;
        const wsUrl = `${protocol}//${host}`;

        const socket = new WebSocket(wsUrl);

        socket.onopen = () => console.log("✅ WebSocket conectado!");

        socket.onmessage = (event) => {
            try {
                const msg = JSON.parse(event.data);
                if (msg.dados && msg.dados.serial_number && msg.dados.serial_number !== serialNumber) return;

                if (msg.type === "nova_leitura_logbox" || msg.type === "nova_leitura") {
                    atualizarPainelLeitura(msg.dados);
                } else if (msg.type === "atualizacao_status") {
                    atualizarPainelCompleto(msg.dados);
                }
            } catch (e) {
                console.error("Erro WS:", e);
            }
        };

        socket.onclose = () => setTimeout(iniciarWebSocket, 5000);
    }

    // --- API CALLS ---
    async function carregarLeiturasIniciais() {
        const loader = document.getElementById("loader-historico");
        const chartContainer = document.getElementById("graficoHistorico");

        try {
            const response = await fetch(`/api/logbox-device/${serialNumber}/leituras`);
            if (!response.ok) throw new Error("Erro API Leituras");
            const data = await response.json();
            gerarGraficoHistorico(data);
            if (loader) loader.style.display = "none";
            if (chartContainer) chartContainer.style.display = "block";
        } catch (error) {
            console.error(error);
            if (loader) loader.innerHTML = `<p class="has-text-danger">Falha ao carregar gráfico</p>`;
        }
    }

    async function carregarStatusInicial() {
        try {
            const response = await fetch(`/api/logbox-device/${serialNumber}/status`);
            if (response.ok) {
                const data = await response.json();
                const statusData = data.status || data;
                
                // DEBUG: Ajuda a ver quais campos estão vindo
                console.log("DEBUG - Dados Recebidos:", statusData);
                
                atualizarPainelCompleto(statusData);
            }
            
            const latestResp = await fetch(`/api/logbox-device/${serialNumber}/latest`);
            if (latestResp.ok) {
                const latest = await latestResp.json();
                if (latest && latest.payload) {
                    const payload = JSON.parse(latest.payload);
                    const temp = extrairTemperatura(payload);
                    if (temp !== null) atualizarTexto("latest-temp", temp.toFixed(1));
                    atualizarTexto("latest-timestamp", `Em: ${new Date(latest.timestamp_leitura).toLocaleString("pt-BR")}`);
                }
            }
        } catch (e) { console.error(e); }
    }

    async function carregarEstatisticasDetalhes() {
        try {
            const res = await fetch(`/api/logbox-device/${serialNumber}/stats-detail`);
            if (res.ok) {
                const stats = await res.json();
                atualizarTexto("stat-today-min", `${stats.today.min} °C`);
                atualizarTexto("stat-today-avg", `${stats.today.avg} °C`);
                atualizarTexto("stat-today-max", `${stats.today.max} °C`);
            }
        } catch (e) { console.error(e); }
    }

    // --- ATUALIZAÇÃO UI ---
    function atualizarPainelCompleto(status) {
        if (!status) return;

        // 1. Conexão
        const connEl = document.getElementById("connection-status-text");
        if (connEl) {
            const isOnline = status.connection_status !== "offline";
            connEl.textContent = isOnline ? "Online" : "Offline";
            connEl.className = isOnline ? "title is-4 has-text-weight-bold has-text-success" : "title is-4 has-text-weight-bold has-text-danger";
        }

        // 2. RSSI
        const rssi = detectarValor(status, ['lqi', 'rssi', 'signal', 'wifi_signal']);
        atualizarTexto("diag-wifi-rssi", `RSSI: ${rssi || "--"} dBm`);

        // 3. Energia
        const tensao = detectarValor(status, ['ch_analog_2', 'supply_voltage', 'input_voltage']);
        const powerInfo = getPowerSourceStatus(tensao);
        atualizarTexto("diag-power-source", powerInfo.text);

        // 4. Bateria
        const bat = detectarValor(status, ['ch_analog_3', 'battery', 'battery_voltage', 'vbat']);
        atualizarTexto("diag-battery-voltage", `Bateria: ${bat ? parseFloat(bat).toFixed(2) : "--"} V`);

        // 5. Temp Interna (MCU)
        const tempInt = detectarValor(status, ['temperature', 'internal_temperature', 'temp_int', 'mcu_temp', 'cpu_temp']);
        atualizarTexto("diag-internal-temp", tempInt ? `${parseFloat(tempInt).toFixed(1)} °C` : "--");

        // 6. IP
        const ip = detectarValor(status, ['ip', 'ip_address', 'net_ip', 'wifi_ip', 'local_ip']);
        atualizarTexto("diag-ip-address", ip || "--");

        // 7. Firmware
        const fw = detectarValor(status, ['firmware_version', 'version', 'fw_version', 'fw', 'sw_version']);
        atualizarTexto("diag-firmware-version", fw || "--");

        // 8. MAC Address (Novo)
        const mac = detectarValor(status, ['mac', 'mac_address', 'wifi_mac', 'device_mac']);
        atualizarTexto("diag-mac-address", mac || "--");

        // 9. Último Pacote (Novo)
        const timestamp = status.timestamp || status.ts || new Date().toISOString();
        const horaFormatada = new Date(timestamp).toLocaleTimeString("pt-BR");
        atualizarTexto("diag-last-packet", horaFormatada);

        atualizarListaAlarmes(status.alarms);
    }

    function atualizarPainelLeitura(dados) {
        const temperatura = extrairTemperatura(dados);
        if (temperatura !== undefined && temperatura !== null) {
            const tempEl = document.getElementById("latest-temp");
            if (tempEl) {
                tempEl.textContent = temperatura.toFixed(1);
                const box = document.getElementById("box-temp");
                if (box) {
                    box.classList.remove("updated-anim");
                    void box.offsetWidth;
                    box.classList.add("updated-anim");
                }
            }
            atualizarGraficoTempoReal(temperatura);
        }
        atualizarTexto("latest-timestamp", `Em: ${new Date().toLocaleString("pt-BR")}`);
        
        // Atualiza diagnósticos se vierem no pacote de leitura
        atualizarPainelCompleto(dados);
    }

    // --- HELPERS ---
    function extrairTemperatura(dados) {
        if (dados.ch_analog_1 !== undefined) return dados.ch_analog_1;
        if (dados.value_channels && Array.isArray(dados.value_channels)) return dados.value_channels[2];
        return null;
    }

    function atualizarTexto(id, texto) {
        const el = document.getElementById(id);
        if (el) el.textContent = texto;
    }

    function atualizarListaAlarmes(alarms) {
        const countEl = document.getElementById("active-alarms-count");
        const subEl = document.getElementById("alarm-subtitle");
        if (!countEl) return;
        let activeCount = 0;
        if (alarms) {
            activeCount = Array.isArray(alarms) 
                ? alarms.filter(a => a === 1).length 
                : Object.values(alarms).filter(v => v === true).length;
        }
        countEl.textContent = activeCount;
        if (subEl) subEl.textContent = activeCount > 0 ? `${activeCount} Alarme(s)` : "Sistema Normal";
        
        // Muda cor do card se tiver alarme
        const box = countEl.closest('.box');
        if(activeCount > 0) {
            box.style.border = "2px solid #f14668";
            countEl.classList.add("has-text-danger");
        } else {
            box.style.border = "1px solid #eef0f5";
            countEl.classList.remove("has-text-danger");
        }
    }

    function getPowerSourceStatus(voltage) {
        if (voltage === undefined || voltage === null) return { text: "Verificando..." };
        return voltage > 9 ? { text: "Rede Elétrica" } : { text: "Apenas Bateria" };
    }

    // --- GRÁFICO ---
    function gerarGraficoHistorico(dados) {
        const container = document.getElementById("graficoHistorico");
        if (!container || !dados.labels || dados.labels.length === 0) {
            if (container) container.innerHTML = '<p class="has-text-centered py-6 has-text-grey">Sem dados históricos disponíveis.</p>';
            return;
        }
        if (historicoChartInstance) historicoChartInstance.dispose();

        const chartData = dados.labels.map((label, index) => {
            // Parse data BR
            let timestamp;
            if (typeof label === 'string' && label.includes('/')) {
                const parts = label.split(/[\/\s:]/);
                timestamp = new Date(parts[2], parts[1] - 1, parts[0], parts[3] || 0, parts[4] || 0, parts[5] || 0).getTime();
            } else {
                timestamp = new Date(label).getTime();
            }
            return [timestamp, dados.temperaturas[index]];
        });

        historicoChartInstance = echarts.init(container);
        const option = {
            tooltip: {
                trigger: 'axis',
                backgroundColor: 'rgba(255, 255, 255, 0.9)',
                borderColor: '#ccc',
                borderWidth: 1,
                textStyle: { color: '#333' },
                formatter: params => {
                    if (!params[0]) return '';
                    const d = new Date(params[0].value[0]);
                    return `<strong>${d.toLocaleTimeString("pt-BR")}</strong><br/>Temp: <strong>${params[0].value[1].toFixed(1)} °C</strong>`;
                }
            },
            grid: { left: '40', right: '20', bottom: '30', top: '30', containLabel: true },
            xAxis: {
                type: 'time',
                boundaryGap: false,
                axisLine: { lineStyle: { color: '#ccc' } },
                axisLabel: { color: '#666' }
            },
            yAxis: {
                type: 'value',
                splitLine: { lineStyle: { type: 'dashed', color: '#eee' } },
                axisLabel: { formatter: '{value} °C', color: '#666' }
            },
            series: [{
                name: 'Temperatura',
                type: 'line',
                smooth: true,
                showSymbol: false,
                data: chartData,
                lineStyle: { color: '#3298dc', width: 3 },
                areaStyle: {
                    color: new echarts.graphic.LinearGradient(0, 0, 0, 1, [
                        { offset: 0, color: 'rgba(50, 152, 220, 0.4)' },
                        { offset: 1, color: 'rgba(50, 152, 220, 0.0)' }
                    ])
                }
            }]
        };
        historicoChartInstance.setOption(option);
        window.addEventListener("resize", () => historicoChartInstance && historicoChartInstance.resize());
    }

    function atualizarGraficoTempoReal(temperatura) {
        if (!historicoChartInstance) return;
        const now = new Date().getTime();
        const option = historicoChartInstance.getOption();
        if (option && option.series && option.series[0]) {
            const data = option.series[0].data;
            data.push([now, temperatura]);
            if (data.length > 200) data.shift();
            historicoChartInstance.setOption({ series: [{ data: data }] });
        }
    }
</script>

</body>
</html>
