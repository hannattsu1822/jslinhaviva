Ótima observação\! Encontrou o erro exato. Peço desculpa, o erro foi meu ao preparar os ficheiros.

O erro `localTag is not defined` significa que o ficheiro de rota (`rotas_logbox.js`) enviou os dados do dispositivo para a página, mas o ficheiro HTML (`device-detail.html`) tentou aceder a uma variável com o nome errado.

  * **O que a rota enviou:** Um objeto chamado `device`, que contém `device.local_tag`.
  * **O que o HTML tentou usar:** Uma variável solta chamada `localTag`, que não existe.

A solução é corrigir o ficheiro HTML para que ele use a variável correta. Abaixo estão os dois ficheiros corrigidos para garantir consistência.

### 1\. Backend: Ficheiro `rotas_logbox.js` Corrigido

Este ficheiro está correto, mas vou enviá-lo novamente para garantir que estamos a usar a versão mais recente e consistente.

```javascript
const express = require("express");
const router = express.Router();
const { promisePool } = require("../init");
const { autenticar, verificarNivel } = require("../auth");
const { PDFDocument, rgb, StandardFonts } = require("pdf-lib");
const { ChartJSNodeCanvas } = require("chartjs-node-canvas");

function formatarDuracao(segundos) {
  if (segundos === null || segundos === undefined) return "Em andamento";
  if (segundos < 60) return `${segundos} seg`;
  if (segundos < 3600)
    return `${Math.floor(segundos / 60)} min ${segundos % 60} seg`;
  const horas = Math.floor(segundos / 3600);
  const minutos = Math.floor((segundos % 3600) / 60);
  return `${horas}h ${minutos}min`;
}

async function getReportData(filters) {
  const { deviceId, reportType, date, month, year } = filters;
  let deviceInfo = null;
  let startDate, endDate;

  switch (reportType) {
    case "monthly":
      startDate = new Date(`${month}-01T00:00:00`);
      endDate = new Date(startDate.getFullYear(), startDate.getMonth() + 1, 0);
      endDate.setHours(23, 59, 59, 999);
      break;
    case "annual":
      startDate = new Date(`${year}-01-01T00:00:00`);
      endDate = new Date(`${year}-12-31T23:59:59`);
      break;
    default:
      startDate = new Date(`${date}T00:00:00`);
      endDate = new Date(`${date}T23:59:59`);
      break;
  }

  const [deviceRows] = await promisePool.query(
    "SELECT * FROM dispositivos_logbox WHERE id = ?",
    [deviceId]
  );
  if (deviceRows.length > 0) {
    deviceInfo = deviceRows[0];
  }

  const [readings] = await promisePool.query(
    "SELECT * FROM leituras_logbox WHERE dispositivo_id = ? AND timestamp_leitura BETWEEN ? AND ? ORDER BY timestamp_leitura ASC",
    [deviceId, startDate, endDate]
  );
  const [stats] = await promisePool.query(
    "SELECT MIN(temperatura_externa) as temp_min, AVG(temperatura_externa) as temp_avg, MAX(temperatura_externa) as temp_max FROM leituras_logbox WHERE dispositivo_id = ? AND timestamp_leitura BETWEEN ? AND ?",
    [deviceId, startDate, endDate]
  );
  const [fanHistory] = await promisePool.query(
    "SELECT * FROM historico_ventilacao WHERE dispositivo_id = ? AND timestamp_inicio >= ? AND timestamp_inicio <= ? ORDER BY timestamp_inicio DESC",
    [deviceId, startDate, endDate]
  );
  const [connectionHistory] = await promisePool.query(
    "SELECT * FROM historico_conexao WHERE serial_number = ? AND timestamp_offline >= ? AND timestamp_offline <= ? ORDER BY timestamp_offline DESC",
    [deviceInfo.serial_number, startDate, endDate]
  );

  return {
    device: deviceInfo,
    filters: { ...filters, startDate, endDate },
    readings,
    stats: stats[0],
    fanHistory,
    connectionHistory,
  };
}

router.get("/gerenciar-dispositivos", autenticar, async (req, res) => {
  try {
    const [devices] = await promisePool.query(
      "SELECT id, local_tag, serial_number, descricao, ativo, ultima_leitura, status_json FROM dispositivos_logbox ORDER BY local_tag"
    );

    const devicesComStatus = devices.map(device => {
      let status = {};
      try {
        if (device.status_json && typeof device.status_json === 'string') {
          status = JSON.parse(device.status_json);
        } else {
          status = device.status_json || {};
        }
      } catch (e) {
        console.error(`Erro ao parsear status_json para SN ${device.serial_number}:`, device.status_json);
        status = {};
      }
      
      const temperaturaExterna = status.ch_analog_1 !== undefined ? status.ch_analog_1 : (status.value_channels ? status.value_channels[2] : null);
      
      return {
        ...device,
        temperatura_externa: temperaturaExterna,
        connection_status: status.connection_status || 'offline',
      };
    });

    res.render("pages/logbox/gerenciar-dispositivos.html", {
      pageTitle: "Gerenciar Dispositivos LogBox",
      user: req.user,
      devices: devicesComStatus,
    });
  } catch (err) {
    console.error("Erro ao buscar dispositivos:", err);
    res.status(500).send("Erro interno ao buscar dispositivos.");
  }
});

router.get("/logbox-devices", autenticar, async (req, res) => {
  try {
    const [devices] = await promisePool.query(
      "SELECT id, local_tag, serial_number, ativo FROM dispositivos_logbox WHERE ativo = 1 ORDER BY local_tag"
    );
    res.render("pages/logbox/device-list.html", {
      pageTitle: "Equipamentos LogBox",
      user: req.user,
      devices,
    });
  } catch (err) {
    console.error(err);
    res.status(500).send("Erro ao buscar dispositivos");
  }
});

router.get(
  "/logbox-device/:serialNumber",
  autenticar,
  async (req, res) => {
    const { serialNumber } = req.params;
    try {
      const [deviceRows] = await promisePool.query(
        "SELECT * FROM dispositivos_logbox WHERE serial_number = ?",
        [serialNumber]
      );
      if (deviceRows.length === 0) {
        return res.status(404).send("Dispositivo não encontrado");
      }
      const device = deviceRows[0];
      res.render("pages/logbox/device-detail.html", {
        pageTitle: `Monitorando: ${device.local_tag}`,
        user: req.user,
        serialNumber: device.serial_number,
        device: device,
      });
    } catch (err) {
      console.error(err);
      res.status(500).send("Erro ao carregar a página do dispositivo");
    }
  }
);

router.get("/api/dispositivos", autenticar, async (req, res) => {
  try {
    const [rows] = await promisePool.query(
      "SELECT id, local_tag, serial_number, descricao, ativo, ultima_leitura FROM dispositivos_logbox ORDER BY local_tag"
    );
    res.json(rows);
  } catch (err) {
    console.error("Erro ao buscar dispositivos:", err);
    res.status(500).json({ message: "Erro interno no servidor" });
  }
});

router.get("/api/dispositivos/:id", autenticar, async (req, res) => {
  try {
    const { id } = req.params;
    const [rows] = await promisePool.query(
      "SELECT * FROM dispositivos_logbox WHERE id = ?",
      [id]
    );
    if (rows.length === 0) {
      return res.status(404).json({ message: "Dispositivo não encontrado" });
    }
    res.json(rows[0]);
  } catch (err) {
    console.error("Erro ao buscar dispositivo:", err);
    res.status(500).json({ message: "Erro interno no servidor" });
  }
});

router.post("/api/dispositivos", autenticar, async (req, res) => {
  try {
    const { id, local_tag, serial_number, descricao } = req.body;
    if (id) {
      await promisePool.query(
        "UPDATE dispositivos_logbox SET local_tag = ?, serial_number = ?, descricao = ? WHERE id = ?",
        [local_tag, serial_number, descricao, id]
      );
      res.json({ message: "Dispositivo atualizado com sucesso!" });
    } else {
      await promisePool.query(
        "INSERT INTO dispositivos_logbox (local_tag, serial_number, descricao) VALUES (?, ?, ?)",
        [local_tag, serial_number, descricao]
      );
      res.json({ message: "Dispositivo adicionado com sucesso!" });
    }
  } catch (err) {
    console.error("Erro ao salvar dispositivo:", err);
    if (err.code === "ER_DUP_ENTRY") {
      return res
        .status(400)
        .json({ message: "Número de série ou tag já cadastrado." });
    }
    res.status(500).json({ message: "Erro interno no servidor" });
  }
});

router.delete("/api/dispositivos/:id", autenticar, async (req, res) => {
  try {
    const { id } = req.params;
    await promisePool.query("DELETE FROM dispositivos_logbox WHERE id = ?", [
      id,
    ]);
    res.json({ message: "Dispositivo excluído com sucesso!" });
  } catch (err) {
    console.error("Erro ao excluir dispositivo:", err);
    res.status(500).json({ message: "Erro interno no servidor" });
  }
});

router.get(
  "/api/logbox-device/:serialNumber/leituras",
  autenticar,
  async (req, res) => {
    const { serialNumber } = req.params;
    try {
      const [device] = await promisePool.query(
        "SELECT id FROM dispositivos_logbox WHERE serial_number = ?",
        [serialNumber]
      );
      if (device.length === 0) return res.status(404).send("Device not found");

      const [rows] = await promisePool.query(
        "SELECT temperatura_externa, timestamp_leitura FROM leituras_logbox WHERE dispositivo_id = ? ORDER BY timestamp_leitura DESC LIMIT 200",
        [device[0].id]
      );
      const reversedRows = rows.reverse();
      const data = {
        labels: reversedRows.map((r) =>
          new Date(r.timestamp_leitura).toLocaleString("pt-BR")
        ),
        temperaturas: reversedRows.map((r) => r.temperatura_externa),
      };
      res.json(data);
    } catch (error) {
      console.error(error);
      res.status(500).send("Server error");
    }
  }
);

router.get(
  "/api/logbox-device/:serialNumber/status",
  autenticar,
  async (req, res) => {
    const { serialNumber } = req.params;
    try {
      const [rows] = await promisePool.query(
        "SELECT status_json FROM dispositivos_logbox WHERE serial_number = ?",
        [serialNumber]
      );
      if (rows.length === 0 || !rows[0].status_json) {
        return res.status(404).json({ status: {} });
      }
      res.json({ status: rows[0].status_json });
    } catch (err) {
      console.error(err);
      res.status(500).json({ message: "Erro ao buscar status" });
    }
  }
);

router.get(
  "/api/logbox-device/:serialNumber/latest",
  autenticar,
  async (req, res) => {
    const { serialNumber } = req.params;
    try {
      const [device] = await promisePool.query(
        "SELECT id FROM dispositivos_logbox WHERE serial_number = ?",
        [serialNumber]
      );
      if (device.length === 0) return res.status(404).send("Device not found");
      const [latest] = await promisePool.query(
        "SELECT payload, timestamp_leitura FROM leituras_logbox WHERE dispositivo_id = ? ORDER BY timestamp_leitura DESC LIMIT 1",
        [device[0].id]
      );
      if (latest.length === 0) return res.status(404).send("No readings found");
      res.json(latest[0]);
    } catch (error) {
      console.error(error);
      res.status(500).send("Server error");
    }
  }
);

router.get(
  "/api/logbox-device/:serialNumber/stats-detail",
  autenticar,
  async (req, res) => {
    const { serialNumber } = req.params;
    try {
      const [device] = await promisePool.query(
        "SELECT id FROM dispositivos_logbox WHERE serial_number = ?",
        [serialNumber]
      );
      if (device.length === 0) return res.status(404).send("Device not found");

      const today = new Date();
      today.setHours(0, 0, 0, 0);
      const month = new Date(today.getFullYear(), today.getMonth(), 1);

      const [[todayStats]] = await promisePool.query(
        "SELECT MIN(temperatura_externa) as min, AVG(temperatura_externa) as avg, MAX(temperatura_externa) as max FROM leituras_logbox WHERE dispositivo_id = ? AND timestamp_leitura >= ?",
        [device[0].id, today]
      );
      const [[monthStats]] = await promisePool.query(
        "SELECT MIN(temperatura_externa) as min, AVG(temperatura_externa) as avg, MAX(temperatura_externa) as max FROM leituras_logbox WHERE dispositivo_id = ? AND timestamp_leitura >= ?",
        [device[0].id, month]
      );

      const format = (stats) => ({
        min: stats.min?.toFixed(1) || "N/A",
        avg: stats.avg?.toFixed(1) || "N/A",
        max: stats.max?.toFixed(1) || "N/A",
      });

      res.json({ today: format(todayStats), month: format(monthStats) });
    } catch (error) {
      console.error(error);
      res.status(500).send("Server error");
    }
  }
);

router.get(
  "/api/logbox-device/:serialNumber/ventilation-history",
  autenticar,
  async (req, res) => {
    const { serialNumber } = req.params;
    try {
      const [device] = await promisePool.query(
        "SELECT id FROM dispositivos_logbox WHERE serial_number = ?",
        [serialNumber]
      );
      if (device.length === 0) return res.status(404).send("Device not found");
      const [history] = await promisePool.query(
        "SELECT * FROM historico_ventilacao WHERE dispositivo_id = ? ORDER BY timestamp_inicio DESC LIMIT 50",
        [device[0].id]
      );
      res.json(history);
    } catch (error) {
      console.error(error);
      res.status(500).send("Server error");
    }
  }
);

router.post("/api/relatorios/visual", autenticar, async (req, res) => {
  try {
    const data = await getReportData(req.body);
    res.json(data);
  } catch (err) {
    console.error("Erro ao gerar relatório visual:", err);
    res.status(500).json({ message: "Erro ao gerar dados do relatório" });
  }
});

router.post(
  "/api/relatorios/pdf",
  autenticar,
  verificarNivel(1),
  async (req, res) => {
    try {
      const data = await getReportData(req.body);

      const chartJSNodeCanvas = new ChartJSNodeCanvas({
        width: 700,
        height: 350,
      });
      const configuration = {
        type: "line",
        data: {
          labels: data.readings.map((r) =>
            new Date(r.timestamp_leitura).toLocaleDateString("pt-BR")
          ),
          datasets: [
            {
              label: "Temperatura (°C)",
              data: data.readings.map((r) => r.temperatura_externa),
              borderColor: "rgb(75, 192, 192)",
              tension: 0.1,
            },
          ],
        },
        options: {
          scales: { y: { beginAtZero: false } },
          animation: { duration: 0 },
        },
      };
      const imageBuffer = await chartJSNodeCanvas.renderToBuffer(configuration);

      const pdfDoc = await PDFDocument.create();
      const page = pdfDoc.addPage();
      const { width, height } = page.getSize();
      const font = await pdfDoc.embedFont(StandardFonts.Helvetica);
      const image = await pdfDoc.embedPng(imageBuffer);
      const imageDims = image.scale(0.5);

      page.drawText(`Relatório de Monitoramento - ${data.device.local_tag}`, {
        x: 50,
        y: height - 50,
        font,
        size: 18,
      });
      page.drawImage(image, {
        x: 50,
        y: height - 100 - imageDims.height,
        width: imageDims.width,
        height: imageDims.height,
      });

      let y = height - 120 - imageDims.height;
      data.readings.forEach((reading) => {
        if (y < 40) {
          page.addPage();
          y = height - 40;
        }
        page.drawText(`${new Date(reading.timestamp_leitura).toLocaleString("pt-BR")}: ${reading.temperatura_externa.toFixed(1)}°C`, { x: 50, y, font, size: 10 });
        y -= 15;
      });

      const pdfBytes = await pdfDoc.save();
      res.setHeader("Content-Type", "application/pdf");
      res.setHeader(
        "Content-Disposition",
        "attachment; filename=relatorio.pdf"
      );
      res.send(Buffer.from(pdfBytes));
    } catch (err) {
      console.error("Erro ao gerar PDF com pdf-lib:", err);
      res.status(500).json({ message: "Erro ao gerar PDF" });
    }
  }
);
router.get(
  "/api/logbox-device/:serialNumber/connection-history",
  autenticar,
  async (req, res) => {
    const { serialNumber } = req.params;
    try {
      const [history] = await promisePool.query(
        "SELECT * FROM historico_conexao WHERE serial_number = ? ORDER BY timestamp_offline DESC LIMIT 100",
        [serialNumber]
      );

      const [[summary]] = await promisePool.query(
        "SELECT COUNT(*) as total_disconnects, AVG(duracao_segundos) as avg_duration FROM historico_conexao WHERE serial_number = ?",
        [serialNumber]
      );

      res.json({
        summary: {
          total_disconnects: summary.total_disconnects || 0,
          avg_duration_seconds: summary.avg_duration || 0,
        },
        history,
      });
    } catch (error) {
      console.error("Erro ao carregar histórico de conexão:", error);
      res.status(500).send("Server error");
    }
  }
);

module.exports = router;
```

-----

### 2\. Frontend: Ficheiro `device-detail.html` Corrigido

Este ficheiro foi ajustado para usar a variável correta (`device.local_tag`) que a rota lhe envia, em vez de `localTag`.

```html
<!DOCTYPE html>
<html lang="pt-BR">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title><%= pageTitle %></title>

    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css"
      rel="stylesheet"
      integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH"
      crossorigin="anonymous"
    />

    <link
      rel="stylesheet"
      href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@20..48,100..700,0..1,-50..200"
    />

    <link rel="stylesheet" href="/static/css/logbox/device-detail.css" />
  </head>
  <body class="bg-light">
    <div class="container-fluid p-4">
      <div class="d-flex justify-content-between align-items-center mb-4">
        <div class="d-flex align-items-center">
          <span class="material-symbols-outlined icon-header">sensors</span>
          <h1 class="h3 mb-0 ms-2"><%= device.local_tag %></h1>
          <span id="connection-status-badge" class="badge ms-3 fs-6"></span>
        </div>
        <div class="d-flex align-items-center">
          <div id="geral-status-indicator" class="status-indicator"></div>
          <a
            href="/gerenciar-dispositivos"
            class="btn btn-outline-secondary d-flex align-items-center"
          >
            <span class="material-symbols-outlined me-2">arrow_back</span>
            Voltar
          </a>
        </div>
      </div>

      <div class="row">
        <div class="col-lg-8">
          <div class="card shadow-sm mb-4">
            <div class="card-header">
              <span class="material-symbols-outlined me-2">thermostat</span>
              Leitura em Tempo Real
            </div>
            <div class="card-body text-center">
              <div class="live-temp-display">
                <span id="latest-temp">--</span>
                <span class="unit">°C</span>
              </div>
              <small id="latest-timestamp" class="text-muted"
                >Aguardando dados...</small
              >
            </div>
          </div>

          <div class="card shadow-sm mb-4">
            <div class="card-header">
              <span class="material-symbols-outlined me-2">timeline</span>
              Histórico de Temperatura (Últimas Leituras)
            </div>
            <div class="card-body">
              <div id="loader-historico" class="chart-loader">
                <div class="spinner"></div>
                Carregando histórico...
              </div>
              <div class="chart-container">
                <canvas
                  id="graficoHistorico"
                  style="display: none"
                ></canvas>
              </div>
            </div>
          </div>

          <div class="card shadow-sm mb-4">
            <div class="card-header">
              <span class="material-symbols-outlined me-2">query_stats</span>
              Estatísticas
            </div>
            <div class="card-body">
              <div class="row text-center">
                <div class="col-md-4">
                  <h6 class="text-muted">Hoje</h6>
                  <p class="stat-value">
                    <span id="stat-today-min">--</span> /
                    <span id="stat-today-avg">--</span> /
                    <span id="stat-today-max">--</span>
                  </p>
                  <small>Min / Média / Max</small>
                </div>
                <div class="col-md-4">
                  <h6 class="text-muted">Este Mês</h6>
                  <p class="stat-value">
                    <span id="stat-month-min">--</span> /
                    <span id="stat-month-avg">--</span> /
                    <span id="stat-month-max">--</span>
                  </p>
                  <small>Min / Média / Max</small>
                </div>
                <div class="col-md-4">
                  <h6 class="text-muted">Total de Desconexões</h6>
                  <p id="conn-total-disconnects" class="stat-value">--</p>
                  <small>Desde o início</small>
                </div>
              </div>
            </div>
          </div>
        </div>

        <div class="col-lg-4">
          <div class="card shadow-sm mb-4">
            <div class="card-header">
              <span class="material-symbols-outlined me-2"
                >developer_board</span
              >
              Diagnóstico do Dispositivo
            </div>
            <div class="list-group list-group-flush">
              <div
                class="list-group-item d-flex justify-content-between align-items-center"
              >
                <div>
                  <span class="material-symbols-outlined me-2 text-primary"
                    >wifi</span
                  >
                  Sinal Wi-Fi (RSSI)
                </div>
                <span id="diag-wifi-rssi" class="badge bg-secondary">--</span>
              </div>
              <div
                class="list-group-item d-flex justify-content-between align-items-center"
              >
                <div>
                  <span class="material-symbols-outlined me-2 text-success"
                    >power</span
                  >
                  Fonte de Energia
                </div>
                <span id="diag-power-source" class="badge bg-secondary"
                  >--</span
                >
              </div>
              <div
                class="list-group-item d-flex justify-content-between align-items-center"
              >
                <div>
                  <span class="material-symbols-outlined me-2 text-warning"
                    >battery_charging_full</span
                  >
                  Tensão da Bateria
                </div>
                <span id="diag-battery-voltage" class="badge bg-secondary"
                  >--</span
                >
              </div>
              <div
                class="list-group-item d-flex justify-content-between align-items-center"
              >
                <div>
                  <span class="material-symbols-outlined me-2 text-danger"
                    >device_thermostat</span
                  >
                  Temperatura Interna
                </div>
                <span id="diag-internal-temp" class="badge bg-secondary"
                  >--</span
                >
              </div>
              <div
                class="list-group-item d-flex justify-content-between align-items-center"
              >
                <div>
                  <span class="material-symbols-outlined me-2 text-info"
                    >public</span
                  >
                  Endereço IP
                </div>
                <span id="diag-ip-address" class="badge bg-secondary">--</span>
              </div>
              <div
                class="list-group-item d-flex justify-content-between align-items-center"
              >
                <div>
                  <span class="material-symbols-outlined me-2 text-muted"
                    >memory</span
                  >
                  Versão do Firmware
                </div>
                <span id="diag-firmware-version" class="badge bg-secondary"
                  >--</span
                >
              </div>
            </div>
          </div>

          <div class="card shadow-sm">
            <div class="card-header d-flex align-items-center text-warning">
              <span class="material-symbols-outlined me-2">warning</span>
              Alarmes Ativos
            </div>
            <div id="active-alarms-list" class="list-group list-group-flush">
              <div class="list-group-item text-muted text-center placeholder">
                Nenhum alarme ativo.
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <script
      src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"
      integrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz"
      crossorigin="anonymous"
    ></script>

    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/luxon@^2"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-luxon@^1"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-streaming@^2"></script>

    <script>
      const serialNumber = "<%= serialNumber %>";
    </script>
    <script src="/scripts/logbox/device-detail.js"></script>
  </body>
</html>
```
